<!-- nav-right.component.html modifié -->
<div class="ms-auto">
  <ul class="list-unstyled">
    <li>
      <div class="dropdown pc-h-item" ngbDropdown>
        <a
          class="pc-head-link head-link-secondary dropdown-toggle arrow-none me-0"
          data-bs-toggle="dropdown"
          href="javascript:"
          ngbDropdownToggle
          (click)="!isConnected && connectToChat()"
        >
          <i class="ti ti-bell"></i>
          <!-- Badge pour le compteur de notifications non lues -->
          <span *ngIf="unreadCount > 0" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle">
            {{ unreadCount > 9 ? '9+' : unreadCount }}
          </span>
        </a>
        <div class="dropdown-menu dropdown-notification dropdown-menu-end pc-h-dropdown" ngbDropdownMenu>
          <div class="dropdown-header">
            <br>
            <h5>
              Toutes les Notifications
              <span class="badge bg-warning rounded-pill ms-1">{{ unreadCount }}</span>
            </h5>
          </div>

          <!-- Indicateur de connexion -->
          <div class="px-3 py-2">
            <div class="d-flex align-items-center">
              <div class="status-indicator me-2">
                <span class="badge" [class]="isConnected ? 'bg-success' : 'bg-secondary'">
                  {{ isConnected ? 'Connecté' : 'Déconnecté' }}
                </span>
              </div>
              <small class="text-muted">{{ isLoading ? 'Connexion...' : '' }}</small>
            </div>
            <!-- Affichage des erreurs -->
            <div *ngIf="errorMessage" class="alert alert-warning alert-sm mt-2 mb-0" role="alert">
              {{ errorMessage }}
            </div>
          </div>

          <ng-scrollbar style="height: 300px; overflow-y: auto;" visibility="hover">
            <div class="dropdown-header px-0 text-wrap">
              <div class="list-group list-group-flush w-100">
                <!-- Filtre des notifications -->
                <div class="list-group-item">
                  <select class="form-select" (change)="onFilterChange($event)">
                    <option value="all">Notifications et messages</option>
                    <option value="notif">Notifications</option>
                    <option value="message">Messages</option>
                  </select>
                </div>

                <!-- Section des conversations si elles existent -->
                <ng-container *ngIf="conversations && conversations.length > 0 && toShow.includes('message')">
                  <div *ngFor="let conversation of conversations" class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <div class="user-avtar bg-light-primary">
                          <i class="ti ti-message-circle"></i>
                        </div>
                      </div>
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">{{ getTimeAgo(conversation.updatedAt) }}</span>
                        <h5>
                          {{ getConversationTitle(conversation) }}
                        </h5>
                        <p class="text-body fs-6">
                          {{ conversation.lastMessage?.message || 'Nouvelle conversation' }}
                        </p>
                        <div *ngIf="conversation.unreadCount > 0" class="badge rounded-pill bg-light-danger">
                          {{ conversation.unreadCount }} non lu{{ conversation.unreadCount > 1 ? 's' : '' }}
                        </div>
                        <div *ngIf="isNewConversation(conversation)" class="badge rounded-pill bg-light-warning">
                          Nouveau
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- Section des notifications d'activité -->
                <ng-container *ngIf="notifications && notifications.length > 0 && toShow.includes('notif')">
                  <div *ngFor="let notification of notifications" class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <div class="user-avtar" [class]="getActivityIcon(notification.type).class">
                          <i [class]="getActivityIcon(notification.type).icon"></i>
                        </div>
                      </div>
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">{{ getTimeAgo(notification.createdAt) }}</span>
                        <h5>{{ notification.title || 'Notification' }}</h5>
                        <p class="text-body fs-6">{{ notification.description }}</p>
                        <div *ngIf="isNewNotification(notification)" class="badge rounded-pill bg-light-success">
                          {{ notification.type }}
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- Message si aucune notification -->
                <div *ngIf="(!conversations || conversations.length === 0) && (!notifications || notifications.length === 0)"
                     class="list-group-item text-center py-4">
                  <div class="text-muted">
                    <i class="ti ti-bell-off fs-1"></i>
                    <p class="mt-2">Aucune notification pour le moment</p>
                    <button *ngIf="!isConnected" class="btn btn-sm btn-primary" (click)="connectToChat()">
                      Se connecter aux notifications
                    </button>
                  </div>
                </div>

                <!-- Notifications statiques existantes (à conserver temporairement) -->
                <ng-container *ngIf="showStaticNotifications">
                  <a class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">2 min ago</span>
                        <h5>{{ userDetails ? userDetails.name+' '+userDetails.surname : '' }}</h5>
                        <p class="text-body fs-6">It is a long established fact that a reader will be distracted</p>
                        <div class="badge rounded-pill bg-light-danger">Unread</div>
                        <div class="badge rounded-pill bg-light-warning">New</div>
                      </div>
                    </div>
                  </a>
                  <a class="list-group-item list-group-item-action">
                    <div class="d-flex">
                      <div class="flex-shrink-0">
                        <div class="user-avtar bg-light-success"><i class="ti ti-building-store"></i></div>
                      </div>
                      <div class="flex-grow-1 ms-1">
                        <span class="float-end text-muted">3 min ago</span>
                        <h5>Store Verification Done</h5>
                        <p class="text-body fs-6">We have successfully received your request.</p>
                        <div class="badge rounded-pill bg-light-danger">Unread</div>
                      </div>
                    </div>
                  </a>
                </ng-container>
              </div>
            </div>
          </ng-scrollbar>

          <div class="dropdown-divider"></div>
          <div class="text-center py-2">
<!--            <a href="javascript:" class="link-primary" (click)="markAllAsRead()">-->
<!--              Marquer comme lu-->
<!--            </a>-->
          </div>
        </div>
      </div>
    </li>
    <li>
      <div class="dropdown pc-h-item header-user-profile" ngbDropdown>
        <a
          class="pc-head-link head-link-primary dropdown-toggle arrow-none me-0"
          data-bs-toggle="dropdown"
          href="javascript:"
          ngbDropdownToggle
        >
          <img src="{{ userDetails ? userDetails.photoURL : 'assets/images/user/pharmacien.jpg' }}" alt="{{ userDetails ? userDetails.name+' '+userDetails.surname : '' }}" class="user-avtar" />
          <span>
            <i class="ti ti-settings"></i>
          </span>
        </a>
        <div class="dropdown-menu dropdown-user-profile dropdown-menu-end pc-h-dropdown" ngbDropdownMenu>
          <div class="dropdown-header">
            <h4>{{ userDetails ? userDetails.name+' '+userDetails.surname : '' }}</h4>
            <p class="text-muted">{{ userDetails && userDetails.groups ? userDetails.groups[0].code : '' }}</p>
            <form class="header-search">
              <div class="search-btn">
                <i class="ti ti-search"></i>
              </div>
              <input type="search" class="form-control" placeholder="Search profile options" />
            </form>
            <ng-scrollbar style="height: calc(100vh - 280px)" visibility="hover">
              <hr />
              <div class="settings-block bg-light-primary rounded">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault" />
                  <label class="form-check-label" for="flexSwitchCheckDefault">Activer le dark mode</label>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked />
                  <label class="form-check-label" for="flexSwitchCheckChecked">Activer les Notifications</label>
                </div>
              </div>
              <hr>
              <div class="row">
                <ul class="list-group list-group-flush">
                  <li class="list-group-item">
                    <h5 class="mb-1 text-uppercase">Police de caractere</h5>
                    <p class="text-muted text-sm">Choissez la police d'ecriture</p>
                    <div class="theme-color theme-font-style">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="layout_font"
                          id="layoutfontRoboto"
                          checked
                          [checked]="setFontFamily === 'Roboto'"
                          (click)="fontFamily('Roboto', true)"
                          ngbTooltip="Roboto"
                        />
                        <label class="form-check-label" for="layoutfontRoboto">Roboto</label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="layout_font"
                          id="layoutfontPoppins"
                          [checked]="setFontFamily === 'Poppins'"
                          (click)="fontFamily('Poppins', true)"
                          ngbTooltip="Poppins"
                        />
                        <label class="form-check-label" for="layoutfontPoppins">Poppins</label>
                      </div>
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="radio"
                          name="layout_font"
                          id="layoutfontInter"
                          [checked]="setFontFamily === 'Inter'"
                          (click)="fontFamily('Inter', true)"
                          ngbTooltip="Inter"
                        />
                        <label class="form-check-label" for="layoutfontInter">Inter</label>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
              <hr />
              <a class="dropdown-item">
                <i class="ti ti-settings"></i>
                <span>Profile</span>
              </a>
              <a href="javascript:" class="dropdown-item" style="background-color: rgb(173, 53, 53); color: aliceblue;" (click)="logout()">
                <i class="ti ti-power"></i>
                <span>Déconnexion</span>
              </a>
            </ng-scrollbar>
          </div>
        </div>
      </div>
    </li>
  </ul>
</div>
