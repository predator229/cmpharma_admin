<!-- ticket-detail.component.html - Style Jira -->
<div class="ticket-container">
  <!-- Header Navigation -->
  <div class="header">
    <div class="breadcrumb">
      <button class="btn btn-subtle" (click)="goBack()">
        <i class="fas fa-arrow-left"></i>
        <span>Retour aux tickets</span>
      </button>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current" *ngIf="ticket">{{ ticket.ticketNumber }}</span>
    </div>

    <div class="header-actions">
      <button class="btn btn-primary" (click)="refresh()" [disabled]="isLoading">
        <i class="fas fa-sync-alt" [class.fa-spin]="isLoading"></i>
        Actualiser
      </button>
    </div>
  </div>

  <!-- Connection Status -->
  <div class="banner banner-warning" *ngIf="!isConnected">
    <i class="fas fa-wifi"></i>
    <span>Reconnexion au systÃ¨me...</span>
  </div>

  <!-- Error Message -->
  <div class="banner banner-error" *ngIf="errorMessage">
    <i class="fas fa-exclamation-triangle"></i>
    <span>{{ errorMessage }}</span>
  </div>

  <!-- Loading State -->
  <div class="loading" *ngIf="isLoading && !ticket">
    <div class="spinner"></div>
    <span>Chargement du ticket...</span>
  </div>

  <!-- Main Content -->
  <div class="content" *ngIf="ticket && !isLoading">

    <!-- Left Column -->
    <div class="main-column">

      <!-- Ticket Header -->
      <div class="ticket-header">
        <div class="ticket-title-section">
          <h1 class="ticket-title" *ngIf="!isEditingTitle" (click)="isEditingTitle=true" >{{ ticket.title }}</h1>
          <div class="description-editor" *ngIf="isEditingTitle">
            <textarea
              [(ngModel)]="ticket.title"
              class="textarea comment-input-container"
            ></textarea>
            <div class="editor-actions">
              <button class="btn-save" (click)="updateTicket()">ðŸ’¾ Enregistrer</button>
              <button class="btn-cancel" (click)="isEditingTitle = false">âœ– Annuler</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="section" *ngIf="!showEditMode && ticket.description">
        <div class="section-header">
          <h3>Description</h3>
        </div>
        <div class="row col-12" >
          <div class="" *ngIf="!isEditing" (click)="enableEdit()" title="Double-cliquez pour Ã©diter"
          ><p [innerHTML]="ticket.description || '<em>Aucune description</em>'"></p>
          </div>
        </div>

        <div class="description-editor" *ngIf="isEditing">
<!--          <quill-editor-->
<!--            #descriptionEditor-->
<!--            [(ngModel)]="ticket.description"-->
<!--            [modules]="quillConfig.modules"-->
<!--            [theme]="quillConfig.theme"-->
<!--            [styles]="{height: '200px'}"-->
<!--          ></quill-editor>-->
          <div class="editor-actions">
            <button class="btn-save" (click)="updateTicket()">ðŸ’¾ Enregistrer</button>
            <button class="btn-cancel" (click)="isEditing = false">âœ– Annuler</button>
          </div>
        </div>
      </div>

      <!-- Activity Section -->
      <div class="section activity-section">
        <div class="comment-form">
          <form [formGroup]="messageForm" (ngSubmit)="sendMessage()">
            <div class="comment-input-wrapper">
              <img src="{{ currentUser.photoURL }}" class="avatar comment-avatar" alt="Votre avatar">

              <div class="comment-input-container">
<!--                <quill-editor-->
<!--                  #messageEditor-->
<!--                  class="comment-input-container"-->
<!--                  formControlName="content"-->
<!--                  [modules]="quillConfig.modules"-->
<!--                  [theme]="quillConfig.theme"-->
<!--                  [styles]="{height: '200px'}"-->
<!--                ></quill-editor>-->
                <!-- Attachments Preview -->
                <div class="attached-files-preview" *ngIf="attachedFiles.length > 0">
                  <div class="attached-file-item" *ngFor="let file of attachedFiles; let i = index">
                    <div class="file-preview">
                      <i class="fas fa-paperclip"></i>
                      <span class="file-name">{{ file.name }}</span>
                      <span class="file-size">({{ (file.size / 1024 / 1024).toFixed(2) }} MB)</span>
                    </div>
                    <button type="button"
                            class="btn btn-icon"
                            (click)="removeAttachment(i)">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>

                <div class="comment-actions">
                  <div class="comment-tools">
                    <input #attachmentInput
                           type="file"
                           multiple
                           style="display: none"
                           (change)="onFileSelected($event)"
                           accept="image/*,application/pdf,.doc,.docx,.txt">

                    <button type="button"
                            class="btn btn-icon"
                            (click)="attachmentInput.click()"
                            title="Joindre un fichier">
                      <i class="fas fa-paperclip"></i>
                    </button>

                    <label class="checkbox">
                      <input type="checkbox" formControlName="isInternal">
                      <span class="checkmark"></span>
                      <span class="checkbox-label">Message interne</span>
                    </label>
                  </div>

                  <div class="comment-submit">
                    <button type="submit"
                            class="btn btn-primary"
                            [disabled]="messageForm.invalid || isSendingMessage">
                      <span *ngIf="isSendingMessage" class="spinner-sm"></span>
                      {{ isSendingMessage ? 'Envoi...' : 'Commenter' }}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="section-header">
          <h3>
            Messages
            <span class="activity-count">({{ getVisibleMessages().length }})</span>
          </h3>

          <div class="activity-filters">
            <button
              class="btn btn-subtle btn-sm"
              [class.active]="showInternalMessages"
              (click)="toggleInternalMessages()">
              <i class="fas fa-lock"></i>
              Messages internes
            </button>
          </div>
        </div>
        <!-- Empty State -->
        <div class="empty-state" *ngIf="getVisibleMessages().length === 0">
          <div class="empty-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h4>Aucun message</h4>
          <p>Soyez le premier Ã  commenter ce ticket</p>
        </div>
        <div class="activity-feed" *ngIf="getVisibleMessages().length > 0">
          <div class="activity-item"
               *ngFor="let message of getVisibleMessages()"
               [class.own-activity]="isCurrentUser(message.author._id)"
               [class.internal-activity]="message.isInternal">

            <div class="activity-avatar">
              <img [src]="message.author.photoURL || 'assets/images/avatars/default.png'"
                   [alt]="message.author.name"
                   class="avatar">
            </div>

            <div class="activity-content">
              <div class="activity-header">
                <span class="activity-author">{{ message.author._id == currentUser.id ? 'Vous' : message.author.name }}</span>
                <span class="activity-action">{{ message.author._id == currentUser.id ? 'a' : 'avez' }} commentÃ©</span>
                <span class="activity-time">{{ formatRelativeDate(message.createdAt) }}</span>
                <span class="activity-badges" *ngIf="message.isInternal">
                  <span class="badge badge-warning">
                    <i class="fas fa-lock"></i>
                    Interne
                  </span>
                </span>
              </div>

              <div class="activity-body">

                <div class="comment-content" [innerHTML]="message.content || '<em>Aucune description</em>'"></div>

                <!-- Attachments -->
                <div class="comment-attachments" *ngIf="message.attachments.length > 0">
                  <div class="attachment-list">
                    <div class="attachment-item" *ngFor="let attachment of message.attachments">
                      <i class="fas fa-paperclip"></i>
                      <a [href]="attachment.url" target="_blank" class="attachment-link">
                        {{ attachment.originalName }}
                      </a>
                      <span class="attachment-size">
                        ({{ (parseFloat(attachment.fileSize) / 1024 / 1024).toFixed(2) }} MB)
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="activity-footer" *ngIf="message.editedAt">
                <span class="edited-indicator">
                  <i class="fas fa-edit"></i>
                  ModifiÃ© {{ formatRelativeDate(message.editedAt) }}
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="section-header">
          <div class="activity-filters" *ngIf="getVisibleMessages().length < ticket.messages.length">
          <button
            class="btn btn-subtle btn-sm"
            (click)="notExtendMessage = !notExtendMessage">
            <i class="fas fa-plus-circle"></i>
            Tout afficher
          </button>
        </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar">
<!--      <div class="sidebar-section">-->
<!--        <div class="sidebar-field">-->
<!--          <label class="label">Statut</label>-->
<!--          <div class="custom-dropdown" [class.open]="isStatusDropdownOpen" #statusDropdown>-->
<!--            <button type="button"-->
<!--                    class="btn btn-dropdown"-->
<!--                    (click)="toggleStatusDropdown()">-->
<!--        <span class="status-badge" [ngClass]="getStatusClass(ticket.status)">-->
<!--          {{ getStatusLabel(ticket.status) }}-->
<!--        </span>-->
<!--              <i class="fas fa-chevron-down" [class.rotated]="isStatusDropdownOpen"></i>-->
<!--            </button>-->
<!--            <ul class="dropdown-menu custom-dropdown-menu"-->
<!--                [class.show]="isStatusDropdownOpen">-->
<!--              <li *ngFor="let option of statusOptions">-->
<!--                <button class="dropdown-item"-->
<!--                        type="button"-->
<!--                        [class.active]="ticket.status === option.value"-->
<!--                        (click)="changeStatus(option.value); closeDropdown(statusDropdown)">-->
<!--            <span class="status-badge" [ngClass]="'status-' + option.value">-->
<!--              {{ option.label }}-->
<!--            </span>-->
<!--                </button>-->
<!--              </li>-->
<!--            </ul>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="sidebar-field">-->
<!--          <label class="label">PrioritÃ©</label>-->
<!--          <div class="custom-dropdown" [class.open]="isPriorityDropdownOpen" #priorityDropdown>-->
<!--            <button class="btn btn-dropdown"-->
<!--                    type="button"-->
<!--                    (click)="togglePriorityDropdown()">-->
<!--        <span class="priority-badge" [ngClass]="getPriorityClass(ticket.priority)">-->
<!--          {{ getPriorityLabel(ticket.priority) }}-->
<!--        </span>-->
<!--              <i class="fas fa-chevron-down" [class.rotated]="isPriorityDropdownOpen"></i>-->
<!--            </button>-->
<!--            <ul class="dropdown-menu custom-dropdown-menu"-->
<!--                [class.show]="isPriorityDropdownOpen">-->
<!--              <li *ngFor="let option of priorityOptions">-->
<!--                <button class="dropdown-item"-->
<!--                        type="button"-->
<!--                        [class.active]="ticket.priority === option.value"-->
<!--                        (click)="changePriority(option.value); closeDropdown(priorityDropdown)">-->
<!--            <span class="priority-badge" [ngClass]="'priority-' + option.value">-->
<!--              {{ option.label }}-->
<!--            </span>-->
<!--                </button>-->
<!--              </li>-->
<!--            </ul>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
      <!-- Details Section -->
      <div class="sidebar-section">
        <h4 class="sidebar-section-title">DÃ©tails</h4>

        <div class="sidebar-field">
          <label class="label">AssignÃ© Ã </label>
          <div class="assignee-field" *ngIf="ticket.assignedTo; else unassigned">
            <img [src]="'assets/images/avatars/default.png'"
                 class="avatar avatar-sm"
                 [alt]="ticket.assignedTo.name">
            <span class="assignee-name">{{ ticket.assignedTo.name }}</span>
          </div>
          <ng-template #unassigned>
            <div class="unassigned-field">
              <i class="fas fa-user-slash"></i>
              <span>Non assignÃ©</span>
            </div>
          </ng-template>
        </div>

        <div class="sidebar-field">
          <label class="label">Rapporteur</label>
          <div class="reporter-field" *ngIf="ticket.createdBy">
            <img [src]="ticket.createdBy.photoURL ?? 'assets/images.avatars/default.png'"
                 class="avatar avatar-sm"
                 [alt]="ticket.createdBy.name">
            <span class="reporter-name">{{ ticket.createdBy.name }}</span>
          </div>
        </div>

        <div class="sidebar-field" *ngIf="ticket.pharmacy">
          <label class="label">Pharmacie</label>
          <div class="pharmacy-field">
            <i class="fas fa-building"></i>
            <div class="pharmacy-info">
              <div class="pharmacy-name">{{ ticket.pharmacy.name }}</div>
              <div class="pharmacy-address" *ngIf="ticket.pharmacy.address">
                {{ ticket.pharmacy.address }}
              </div>
            </div>
          </div>
        </div>

        <div class="sidebar-field">
          <label class="label">CatÃ©gorie</label>
          <span class="category-badge">{{ getCategoryLabel(ticket.category) }}</span>
        </div>
      </div>

      <!-- Dates Section -->
      <div class="sidebar-section">
        <h4 class="sidebar-section-title">Dates</h4>

        <div class="sidebar-field">
          <label class="label">CrÃ©Ã©</label>
          <span class="date-value">{{ formatDate(ticket.createdAt) }}</span>
        </div>

        <div class="sidebar-field" *ngIf="ticket.resolvedAt">
          <label class="label">RÃ©solu</label>
          <span class="date-value">{{ formatDate(ticket.resolvedAt) }}</span>
        </div>

        <div class="sidebar-field">
          <label class="label">DerniÃ¨re activitÃ©</label>
          <span class="date-value">{{ formatRelativeDate(ticket.lastActivity) }}</span>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="sidebar-section">
        <h4 class="sidebar-section-title">Actions</h4>

        <div class="quick-actions">
          <button class="btn btn-default btn-full"
                  *ngIf="ticket.status !== 'resolved'"
                  (click)="changeStatus('resolved')">
            <i class="fas fa-check"></i>
            Marquer comme rÃ©solu
          </button>

          <button class="btn btn-danger btn-full"
                  *ngIf="ticket.status !== 'closed'"
                  (click)="changeStatus('closed')">
            <i class="fas fa-times"></i>
            Fermer le ticket
          </button>
        </div>
      </div>

      <!-- Tags Section -->
      <div class="sidebar-section" *ngIf="ticket.tags && ticket.tags.length > 0">
        <h4 class="sidebar-section-title">Tags</h4>
        <div class="tags-container">
          <span class="tag" *ngFor="let tag of ticket.tags">{{ tag }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
