<!-- Dashboard Header -->
<div class="dashboard-header">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="dashboard-title">
        <i class="fas fa-tachometer-alt me-2"></i>
        Tableau de Bord
      </h2>
      <p class="text-muted mb-0">
        Vue d'overview de votre activité pharmaceutique
        <small class="ms-2">
          <i class="fas fa-clock me-1"></i>
          Dernière mise à jour: {{ lastUpdated | date:'short':'fr-FR' }}
        </small>
      </p>
    </div>
    <div class="d-flex align-items-center gap-2">
      <!-- Statut de connexion -->
      <span class="badge" [ngClass]="isConnected ? 'bg-success' : 'bg-danger'">
        <i class="fas" [ngClass]="isConnected ? 'fa-wifi' : 'fa-wifi-slash'"></i>
        {{ isConnected ? 'Connecté' : 'Déconnecté' }}
      </span>

      <!-- Boutons d'action -->
      <button class="btn btn-outline-primary btn-sm" (click)="refreshDashboard()" [disabled]="isLoading">
        <i class="fas fa-sync-alt" [ngClass]="{'fa-spin': isLoading}"></i>
        Actualiser
      </button>

      <button class="btn btn-outline-secondary btn-sm" (click)="exportDashboard()">
        <i class="fas fa-download"></i>
        Exporter
      </button>
    </div>
  </div>

  <!-- Filtres et vues -->
  <div class="dashboard-filters mb-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="table-responsive btn-group" role="group">
          <button
            *ngFor="let view of availableViews"
            type="button"
            class="btn btn-outline-primary btn-sm"
            [ngClass]="{'active': selectedView === view.value}"
            style="margin-right: 5px;"
            (click)="changeView(view.value)">
            <i [class]="view.icon"></i>
            {{ view.label }}
          </button>
        </div>
      </div>

      <div class="col-md-6">
        <div class="d-flex justify-content-end gap-2">
<!--          <select-->
<!--            class="form-select form-select-sm"-->
<!--            style="width: auto;"-->
<!--            [formControl]="filterForm.get('timeRange')!">-->
<!--            <option value="1d">Aujourd'hui</option>-->
<!--            <option value="7d">7 derniers jours</option>-->
<!--            <option value="30d">30 derniers jours</option>-->
<!--            <option value="90d">90 derniers jours</option>-->
<!--          </select>-->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chargement -->
<div *ngIf="isLoading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Chargement...</span>
  </div>
  <p class="mt-2 text-muted">Chargement des données du dashboard...</p>
</div>

<!-- Erreur -->
<div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="fas fa-exclamation-triangle me-2"></i>
  {{ errorMessage }}
  <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
</div>

<!-- Contenu principal -->
<div *ngIf="!isLoading" class="dashboard-content">

  <!-- Vue d'overview -->
  <div *ngIf="selectedView === 'overview'">

    <!-- Statistiques principales -->
    <div class="row mb-4">
      <!-- Commandes -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card orders-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.orders.total) }}</h3>
                <p class="stats-label">Commandes Totales</p>
                <div class="stats-growth" [ngClass]="getGrowthClass(stats.orders.growthRate)">
                  <i [class]="getGrowthIcon(stats.orders.growthRate)"></i>
                  {{ formatPercentage(stats.orders.growthRate) }}
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <span class="badge bg-warning">{{ stats.orders.pending }}</span>
                  <small class="d-block">En attente</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-success">{{ stats.orders.completed }}</span>
                  <small class="d-block">Complétées</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-danger">{{ stats.orders.cancelled }}</span>
                  <small class="d-block">Annulées</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenus -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card revenue-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <h3 class="stats-number">{{ formatCurrency(stats.orders.revenue) }}</h3>
                <p class="stats-label">Revenus Totaux</p>
                <div class="stats-growth" [ngClass]="getGrowthClass(stats.orders.growthRate)">
                  <i [class]="getGrowthIcon(stats.orders.growthRate)"></i>
                  {{ formatPercentage(stats.orders.growthRate) }}
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-6">
                  <small class="d-block">Commandes Aujourd'hui</small>
                  <span class="fw-bold">{{ stats.orders.todayOrders }}</span>
                </div>
                <div class="col-6">
                  <small class="d-block">Val. Moy. Commande</small>
                  <span class="fw-bold">{{ formatCurrency(stats.orders.averageOrderValue) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tickets -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card tickets-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.tickets.total) }}</h3>
                <p class="stats-label">Tickets Totaux</p>
                <div class="stats-growth text-muted">
                  <small>Temps de réponse: {{ stats.tickets.responseTime | number:'1.0-0' }}h</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <span class="badge bg-info">{{ stats.tickets.open }}</span>
                  <small class="d-block">Ouverts</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-primary">{{ stats.tickets.inProgress }}</span>
                  <small class="d-block">En cours</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-success">{{ stats.tickets.resolved }}</span>
                  <small class="d-block">Résolus</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activités -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card activities-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.activities.total) }}</h3>
                <p class="stats-label">Activités Totales</p>
                <div class="stats-growth text-muted">
                  <small>Aujourd'hui: {{ stats.activities.todayActivities }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <small class="d-block text-center">Utilisateurs les plus actifs:</small>
              <ul class="list-unstyled mb-0">
                <li *ngFor="let user of stats.activities.mostActiveUsers | slice:0:3; trackBy: trackByIndex" class="d-flex justify-content-between align-items-center">
                  <span>{{ user.name }}</span>
                  <span class="badge bg-secondary">{{ user.count }}</span>
                </li>
                <li *ngIf="stats.activities.mostActiveUsers.length === 0" class="text-center text-muted">
                  <small>Aucun utilisateur actif.</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Pharmacies -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card pharmacies-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-hospital"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.pharmacies.total) }}</h3>
                <p class="stats-label">Pharmacies Totales</p>
                <div class="stats-growth text-muted">
                  <small>Actives: {{ stats.pharmacies.active }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <small class="d-block text-center">Top Performantes:</small>
              <ul class="list-unstyled mb-0">
                <li *ngFor="let pharmacy of stats.pharmacies.topPerforming | slice:0:3; trackBy: trackByIndex" class="d-flex justify-content-between align-items-center">
                  <span>{{ pharmacy.name }}</span>
                  <span class="badge bg-success">{{ formatCurrency(pharmacy.revenue) }}</span>
                </li>
                <li *ngIf="stats.pharmacies.topPerforming.length === 0" class="text-center text-muted">
                  <small>Aucune pharmacie top.</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Utilisateurs -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card users-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-users"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.users.total) }}</h3>
                <p class="stats-label">Utilisateurs Totaux</p>
                <div class="stats-growth text-muted">
                  <small>En ligne: {{ stats.users.onlineNow }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-6">
                  <small class="d-block">Actifs</small>
                  <span class="fw-bold">{{ stats.users.active }}</span>
                </div>
                <div class="col-6">
                  <small class="d-block">Nouveaux ce mois</small>
                  <span class="fw-bold">{{ stats.users.newThisMonth }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Rapides -->
    <h4 class="mb-3">Actions Rapides</h4>
    <div class="row mb-4">
      <div *ngFor="let action of quickActions; trackBy: trackByIndex" class="col-3">
        <div class="card quick-action-card h-100" (click)="navigateToQuickAction(action)">
          <div class="card-body text-center">
            <div class="quick-action-icon" [ngClass]="'text-' + action.color">
              <i [class]="action.icon"></i>
            </div>
            <h5 class="mt-3 mb-1">{{ action.title }}</h5>
            <p class="text-muted mb-0">{{ action.description }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphiques du Dashboard -->
    <h4 class="mb-3">Analytiques</h4>

    <div class="col-lg-12 col-md-12 mb-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="fas fa-chart-line me-2"></i>Performance</h5>
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active">
                <i class="fas fa-chart-line me-2"></i>
                Graphique
              </button>
            </li>
          </ul>
        </div>

        <div class="card-body">
          <!-- Résumé des statistiques -->
          <div class="row mb-4" style="margin-top: 50px;">
            <div class="col-md-3">
              <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                <h4 class="text-success mb-1">{{ countOrders }}</h4>
                <small class="text-muted">Total Commandes</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                <h4 class="text-success mb-1">{{ getMonthlyStatsSummary().totalRevenue | currency:'EUR':'symbol':'1.0-0' }}</h4>
                <small class="text-muted">Total Revenus</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                <h4 class="text-warning mb-1">{{ getMonthlyStatsSummary().totalNewCustomers }}</h4>
                <small class="text-muted">Nouveaux Clients</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                <h4 class="text-info mb-1">{{ countOrders/12 }}</h4>
                <small class="text-muted">Moy. Commandes/Mois</small>
              </div>
            </div>
          </div>

          <div class="chart-container" style="height: 400px; position: relative;">
            <canvas #monthlyStatsChart></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-12 mb-3">
      <div class="card mb-4">
        <div class="card-header">
          <h5><i class="fas fa-chart-line me-2"></i>Détail mensuel</h5>
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
              <tr>
                <th>Mois</th>
                <th>Commandes</th>
                <th>Revenus</th>
                <th>Bénéfices</th>
                <th>Nouveaux Clients</th>
                <th>Revenus/Commande</th>
                <th>Évolution</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let stat of monthlyStats; let i = index">
                <td>{{ stat.month }}</td>
                <td>
                  <span class="badge bg-primary">{{ stat.orders }}</span>
                </td>
                <td>
                  <span class="text-success fw-bold">{{ stat.revenue | currency:'EUR':'symbol':'1.0-2' }}</span>
                </td>
                <td>
                  <span class="text-info fw-bold">{{ stat.profit | currency:'EUR':'symbol':'1.0-2' }}</span>
                </td>
                <td>
                  <span class="badge bg-warning text-dark">{{ stat.newCustomers }}</span>
                </td>
                <td>
                    <span class="text-muted">
                      {{ stat.orders > 0 ? ((stat.revenue / stat.orders) | currency:'EUR':'symbol':'1.0-2' ): '0 €' }}
                    </span>
                </td>
                <td>
                  <ng-container *ngIf="i > 0">
                      <span [class]="getEvolutionClass(monthlyStats[i-1].revenue, stat.revenue)"
                            [title]="getEvolutionText(monthlyStats[i-1].revenue, stat.revenue)">
                        {{ getEvolutionPercentage(monthlyStats[i-1].revenue, stat.revenue) }}%
                        <i [class]="getEvolutionIcon(monthlyStats[i-1].revenue, stat.revenue)"></i>
                      </span>
                  </ng-container>
                  <span *ngIf="i === 0" class="text-muted">-</span>
                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="col-lg-6 col-md-12 mb-3">
        <div class="card chart-card">
          <div class="card-header">
            <h5 class="card-title mb-0">Statut des Tickets</h5>
          </div>
          <div class="card-body">
            <canvas #ticketsChart></canvas>
          </div>
        </div>
      </div>
    </div>

      <!-- Activités Récentes -->
    <h4 class="mb-3">Activités Récentes</h4>
    <div class="row">
      <div class="col-12">
        <div class="card recent-activities-card">
          <div class="card-header">
            <h5 class="card-title mb-0">Journal des Activités</h5>
          </div>
          <div class="card-body p-0" style="height: 400px; overflow: auto; ">
            <app-activity-timeline
              [activites]="recentActivities"
              [usersInfo]="usersInfo">
            </app-activity-timeline>
            <div *ngIf="recentActivities.length === 0" class="p-3 text-center text-muted">
              <p class="mb-0">Aucune activité récente à afficher.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue Commandes (placeholder) -->
  <div *ngIf="selectedView === 'orders'" class="py-5 text-center text-muted">
    <h3><i class="fas fa-shopping-cart me-2"></i> Vue des Commandes</h3>
    <p>Cette section affichera les détails et la gestion des commandes.</p>
    <!-- Contenu détaillé des commandes ici -->
  </div>

  <!-- Vue Support (placeholder) -->
  <div *ngIf="selectedView === 'tickets'" class="py-5 text-center text-muted">
    <h3><i class="fas fa-ticket-alt me-2"></i> Vue du Support (Tickets)</h3>
    <p>Cette section affichera les détails et la gestion des tickets de support.</p>
    <!-- Contenu détaillé des tickets ici -->
  </div>

  <!-- Vue Analytiques (placeholder) -->
  <div *ngIf="selectedView === 'analytics'" class="py-5 text-center text-muted">
    <h3><i class="fas fa-chart-bar me-2"></i> Vue Analytiques</h3>
    <p>Cette section affichera des rapports et des analyses plus approfondis.</p>
    <!-- Contenu détaillé des analytiques ici -->
  </div>

</div>
