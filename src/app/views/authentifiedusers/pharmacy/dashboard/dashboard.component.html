<!-- Dashboard Header -->
<div class="dashboard-header">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <!-- TITRE + DESCRIPTION -->
    <div>
      <h2 class="dashboard-title">
        <i class="fas fa-tachometer-alt me-2"></i>
        Tableau de Bord
      </h2>
      <p class="text-muted mb-0">
        Vue d'overview de votre activité pharmaceutique
        <small class="ms-2">
          <i class="fas fa-clock me-1"></i>
          Dernière mise à jour: {{ lastUpdated | date:'EEEE d MMMM yyyy, HH:mm':'fr' }}
        </small>
      </p>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-2">
        <div class="custom-dropdown" [class.open]="isPeriodDropdownOpen" #statusDropdown>
          <button type="button"
                  class="btn btn-dropdown"
                  (click)="toggleStatusDropdown()">
                <span class="status-badge">
                  <i class="fas fa-calendar-alt me-1"></i>
                  {{ getPeriodLabel(selectedPeriod) }}
                </span>
            <i class="fas fa-chevron-down" [class.rotated]="isPeriodDropdownOpen"></i>
          </button>
          <ul class="dropdown-menu custom-dropdown-menu"
              [class.show]="isPeriodDropdownOpen">
            <li *ngFor="let option of optionsPeriodDatas">
              <button class="dropdown-item"
                      type="button"
                      [class.active]="selectedPeriod === option.value"
                      (click)="setDateIntervalFromPeriod(option.value); closeDropdown(statusDropdown)">
              <span class="status-badge" [ngClass]="'status-' + option.value">
                {{ option.label }}
              </span>
              </button>
            </li>
          </ul>
        </div>
<!--        <div class="mb-3">-->
<!--          <label for="restrictions" class="form-label">-->
<!--            <i class="fas fa-calendar-alt me-1"></i>-->
<!--            Période des donnees-->
<!--          </label>-->
<!--            <select2-->
<!--              class="form-control"-->
<!--              id="periodDats"-->
<!--              [data]="optionsPeriodDatas"-->
<!--              onChange="setDateIntervalFromPeriod(this.value)"-->
<!--            >-->
<!--            </select2>-->
<!--        </div>-->


      <!-- Statut de connexion -->
      <span class="badge" [ngClass]="isConnected ? 'bg-success' : 'bg-danger'">
      <i class="fas" [ngClass]="isConnected ? 'fa-wifi' : 'fa-wifi-slash'"></i>
        {{ isConnected ? 'Connecté' : 'Déconnecté' }}
    </span>

      <!-- Boutons d'action -->
      <button class="btn btn-outline-primary btn-sm" (click)="refreshDashboard()" [disabled]="isLoading">
        <i class="fas fa-sync-alt" [ngClass]="{'fa-spin': isLoading}"></i>
        Actualiser
      </button>

      <button class="btn btn-outline-secondary btn-sm" (click)="exportDashboard()">
        <i class="fas fa-download"></i>
        Exporter
      </button>
    </div>
  </div>


  <!-- Filtres et vues -->
  <div class="dashboard-filters mb-4">
    <div class="row align-items-center">
      <div class="col-md-6">
        <div class="table-responsive btn-group" role="group">
          <button
            *ngFor="let view of availableViews"
            type="button"
            class="btn btn-outline-primary btn-sm"
            [ngClass]="{'active': selectedView === view.value}"
            style="margin-right: 5px;"
            (click)="changeView(view.value)">
            <i [class]="view.icon"></i>
            {{ view.label }}
          </button>
        </div>
      </div>

      <div class="col-md-6">
        <div class="d-flex justify-content-end gap-2">
<!--          <select-->
<!--            class="form-select form-select-sm"-->
<!--            style="width: auto;"-->
<!--            [formControl]="filterForm.get('timeRange')!">-->
<!--            <option value="1d">Aujourd'hui</option>-->
<!--            <option value="7d">7 derniers jours</option>-->
<!--            <option value="30d">30 derniers jours</option>-->
<!--            <option value="90d">90 derniers jours</option>-->
<!--          </select>-->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chargement -->
<div *ngIf="isLoading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Chargement...</span>
  </div>
  <p class="mt-2 text-muted">Chargement des données du dashboard...</p>
</div>

<!-- Erreur -->
<div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="fas fa-exclamation-triangle me-2"></i>
  {{ errorMessage }}
  <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
</div>

<!-- Contenu principal -->
<div *ngIf="!isLoading" class="dashboard-content">

  <!-- Vue d'overview -->
  <div *ngIf="selectedView === 'overview'">

    <!-- Statistiques principales -->
    <div class="row mb-4">
      <!-- Commandes -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card orders-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.orders.total) }}</h3>
                <p class="stats-label">Commandes Totales</p>
                <div class="stats-growth" [ngClass]="getGrowthClass(stats.orders.growthRate)">
                  <i [class]="getGrowthIcon(stats.orders.growthRate)"></i>
                  {{ formatPercentage(stats.orders.growthRate) }}
                </div>
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <span class="badge bg-warning">{{ stats.orders.pending }}</span>
                  <small class="d-block">En attente</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-success">{{ stats.orders.completed }}</span>
                  <small class="d-block">Complétées</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-danger">{{ stats.orders.cancelled }}</span>
                  <small class="d-block">Annulées</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Revenus -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card revenue-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-dollar-sign"></i>
                </div>
                <h3 class="stats-number">{{ formatCurrency(stats.orders.revenue) }}</h3>
                <p class="stats-label">Revenus Totaux</p>
                <div class="stats-growth" [ngClass]="getGrowthClass(stats.orders.growthRate)">
                  <i [class]="getGrowthIcon(stats.orders.growthRate)"></i>
                  {{ formatPercentage(stats.orders.growthRate) }}
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-6">
                  <small class="d-block">Commandes Aujourd'hui</small>
                  <span class="fw-bold">{{ stats.orders.todayOrders }}</span>
                </div>
                <div class="col-6">
                  <small class="d-block">Val. Moy. Commande</small>
                  <span class="fw-bold">{{ formatCurrency(stats.orders.averageOrderValue) }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tickets -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card tickets-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-ticket-alt"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.tickets.total) }}</h3>
                <p class="stats-label">Tickets Totaux</p>
                <div class="stats-growth text-muted">
                  <small>Temps de réponse: {{ stats.tickets.responseTime | number:'1.0-0' }}h</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-4">
                  <span class="badge bg-info">{{ stats.tickets.open }}</span>
                  <small class="d-block">Ouverts</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-primary">{{ stats.tickets.inProgress }}</span>
                  <small class="d-block">En cours</small>
                </div>
                <div class="col-4">
                  <span class="badge bg-success">{{ stats.tickets.resolved }}</span>
                  <small class="d-block">Résolus</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Activités -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card activities-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.activities.total) }}</h3>
                <p class="stats-label">Activités Totales</p>
                <div class="stats-growth text-muted">
                  <small>Aujourd'hui: {{ stats.activities.todayActivities }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <small class="d-block text-center">Utilisateurs les plus actifs:</small>
              <ul class="list-unstyled mb-0">
                <li *ngFor="let user of stats.activities.mostActiveUsers | slice:0:3; trackBy: trackByIndex" class="d-flex justify-content-between align-items-center">
                  <span>{{ user.name }}</span>
                  <span class="badge bg-secondary">{{ user.count }}</span>
                </li>
                <li *ngIf="stats.activities.mostActiveUsers.length === 0" class="text-center text-muted">
                  <small>Aucun utilisateur actif.</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Pharmacies -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card pharmacies-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-hospital"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.pharmacies.total) }}</h3>
                <p class="stats-label">Pharmacies Totales</p>
                <div class="stats-growth text-muted">
                  <small>Actives: {{ stats.pharmacies.active }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <small class="d-block text-center">Top Performantes:</small>
              <ul class="list-unstyled mb-0">
                <li *ngFor="let pharmacy of stats.pharmacies.topPerforming | slice:0:3; trackBy: trackByIndex" class="d-flex justify-content-between align-items-center">
                  <span>{{ pharmacy.name }}</span>
                  <span class="badge bg-success">{{ formatCurrency(pharmacy.revenue) }}</span>
                </li>
                <li *ngIf="stats.pharmacies.topPerforming.length === 0" class="text-center text-muted">
                  <small>Aucune pharmacie top.</small>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Utilisateurs -->
      <div class="col-xl-3 col-md-6 mb-3">
        <div class="card stats-card users-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="stats-icon">
                  <i class="fas fa-users"></i>
                </div>
                <h3 class="stats-number">{{ formatNumber(stats.users.total) }}</h3>
                <p class="stats-label">Utilisateurs Totaux</p>
                <div class="stats-growth text-muted">
                  <small>En ligne: {{ stats.users.onlineNow }}</small>
                </div>
              </div>
              <div class="stats-chart-mini">
                <!-- Mini graphique pourrait être ajouté ici -->
              </div>
            </div>
            <div class="stats-details mt-3">
              <div class="row text-center">
                <div class="col-6">
                  <small class="d-block">Actifs</small>
                  <span class="fw-bold">{{ stats.users.active }}</span>
                </div>
                <div class="col-6">
                  <small class="d-block">Nouveaux ce mois</small>
                  <span class="fw-bold">{{ stats.users.newThisMonth }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions Rapides -->
    <div class="row mb-4">
      <div *ngFor="let action of quickActions; trackBy: trackByIndex" class="col-3">
        <div class="card quick-action-card h-100" (click)="navigateToQuickAction(action)">
          <div class="card-body text-center">
            <div class="quick-action-icon" [ngClass]="'text-' + action.color">
              <i [class]="action.icon"></i>
            </div>
            <h5 class="mt-3 mb-1">{{ action.title }}</h5>
            <p class="text-muted mb-0">{{ action.description }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Graphiques du Dashboard -->
    <div class="col-lg-12 col-md-12 mb-3">
      <div class="card chart-card">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="fas fa-chart-line me-2"></i>Performance</h5>
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active">
                <i class="fas fa-chart-line me-2"></i>
                Graphique
              </button>
            </li>
          </ul>
        </div>

        <div class="card-body">
          <!-- Résumé des statistiques -->
          <div class="row mb-4" style="margin-top: 50px;">
            <div class="col-md-3">
              <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
                <h4 class="text-success mb-1">{{ countOrders }}</h4>
                <small class="text-muted">Total Commandes</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                <h4 class="text-success mb-1">{{ getMonthlyStatsSummary().totalRevenue | currency:'EUR':'symbol':'1.0-0' }}</h4>
                <small class="text-muted">Total Revenus</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                <h4 class="text-warning mb-1">{{ getMonthlyStatsSummary().totalNewCustomers }}</h4>
                <small class="text-muted">Nouveaux Clients</small>
              </div>
            </div>
            <div class="col-md-3">
              <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                <h4 class="text-info mb-1">{{ countOrders/12 | number:'1.2-2'  }}</h4>
                <small class="text-muted">Moy. Commandes/Mois</small>
              </div>
            </div>
          </div>

          <div class="chart-container" style="height: 400px; position: relative;">
            <canvas #monthlyStatsChart></canvas>
          </div>
        </div>
      </div>
    </div>
    <div class="row align-items-stretch g-3">
      <div class="col-md-6 mb-3 d-flex">
        <div class="card chart-card">
          <div class="card-header">
            <h5 class="card-title mb-0">
              <i class="fas fa-chart-line me-2"></i>
              Détail mensuel
            </h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                <tr>
                  <th>Mois</th>
                  <th>Commandes</th>
                  <th>Revenus</th>
                  <th>Bénéfices</th>
                  <th>Nouveaux Clients</th>
                  <th>Revenus/Commande</th>
                  <th>Évolution</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let stat of monthlyStats; let i = index">
                  <td>{{ stat.month }}</td>
                  <td>
                    <span class="badge bg-primary">{{ stat.orders }}</span>
                  </td>
                  <td>
                    <span class="text-success fw-bold">{{ stat.revenue | currency:'EUR':'symbol':'1.0-2' }}</span>
                  </td>
                  <td>
                    <span class="text-info fw-bold">{{ stat.profit | currency:'EUR':'symbol':'1.0-2' }}</span>
                  </td>
                  <td>
                    <span class="badge bg-warning text-dark">{{ stat.newCustomers }}</span>
                  </td>
                  <td>
                      <span class="text-muted">
                        {{ stat.orders > 0 ? ((stat.revenue / stat.orders) | currency:'EUR':'symbol':'1.0-2' ): '0 €' }}
                      </span>
                  </td>
                  <td>
                    <ng-container *ngIf="i > 0">
                        <span [class]="getEvolutionClass(monthlyStats[i-1].revenue, stat.revenue)"
                              [title]="getEvolutionText(monthlyStats[i-1].revenue, stat.revenue)">
                          {{ getEvolutionPercentage(monthlyStats[i-1].revenue, stat.revenue) }}%
                          <i [class]="getEvolutionIcon(monthlyStats[i-1].revenue, stat.revenue)"></i>
                        </span>
                    </ng-container>
                    <span *ngIf="i === 0" class="text-muted">-</span>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-md-6 mb-3">
        <div class="row">
        <!-- Graphique des commandes -->
          <div class="col-lg-12 col-md-6 mb-3">
            <div class="card chart-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <i class="fas fa-shopping-cart me-2"></i>
                  Évolution des Commandes
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container" style="height: 300px; position: relative;">
                  <canvas #ordersChart></canvas>
                </div>
              </div>
            </div>
          </div>
          <!-- Graphique des revenus -->
          <div class="col-lg-12 col-md-12 mb-3">
            <div class="card chart-card">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <i class="fas fa-dollar-sign me-2"></i>
                  Évolution des Revenus
                </h5>
              </div>
              <div class="card-body">
                <div class="chart-container" style="height: 300px; position: relative;">
                  <canvas #revenueChart></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue détaillée des commandes -->
  <div *ngIf="selectedView === 'orders'" class="orders-view">
    <div class="row mb-4">
      <!-- Filtres spécifiques aux commandes -->
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-filter me-2"></i>Filtres des Commandes</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <select class="form-select" [(ngModel)]="ordersFilter.status">
                  <option value="">Tous les statuts</option>
                  <option value="pending">En attente</option>
                  <option value="completed">Complétées</option>
                  <option value="cancelled">Annulées</option>
                  <option value="processing">En cours</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" [(ngModel)]="ordersFilter.pharmacy">
                  <option value="">Toutes les pharmacies</option>
                  <option *ngFor="let pharmacy of availablePharmacies" [value]="pharmacy.id">
                    {{ pharmacy.name }}
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control" [(ngModel)]="ordersFilter.dateFrom" placeholder="Date début">
              </div>
              <div class="col-md-3">
                <input type="date" class="form-control" [(ngModel)]="ordersFilter.dateTo" placeholder="Date fin">
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-12">
                <button class="btn btn-primary me-2" (click)="applyOrdersFilter()">
                  <i class="fas fa-search"></i> Appliquer
                </button>
                <button class="btn btn-outline-secondary" (click)="resetOrdersFilter()">
                  <i class="fas fa-times"></i> Réinitialiser
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des commandes récentes -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-list me-2"></i>Commandes Récentes</h5>
            <button class="btn btn-outline-primary btn-sm" (click)="exportOrders()">
              <i class="fas fa-download me-1"></i>Exporter
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                <tr>
                  <th>ID Commande</th>
                  <th>Client</th>
                  <th>Pharmacie</th>
                  <th>Montant</th>
                  <th>Statut</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let order of filteredRecentOrders; trackBy: trackByOrderId">
                  <td>
                    <span class="fw-bold">#{{ order.orderNumber }}</span>
                  </td>
                  <td>{{ order.customer.getFullName() || 'N/A' }}</td>
                  <td>{{ order.customer.getFullName() || 'N/A' }}</td>
                  <td>
                    <span class="fw-bold text-success">{{ formatCurrency(order.totalAmount) }}</span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getStatusBadgeClass(order.status)">
                      {{ order.status | titlecase }}
                    </span>
                  </td>
                  <td>{{ order.createdAt | date:'short':'fr-FR' }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" (click)="viewOrder(order._id)">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" (click)="editOrder(order._id)">
                      <i class="fas fa-edit"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="filteredRecentOrders.length === 0" class="text-center py-4">
              <i class="fas fa-shopping-cart fa-2x text-muted mb-3"></i>
              <p class="text-muted">Aucune commande trouvée avec les filtres actuels.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue détaillée des tickets -->
  <div *ngIf="selectedView === 'tickets'" class="tickets-view">
    <div class="row mb-4">
      <!-- Statistiques des tickets -->
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-ticket-alt fa-2x text-info mb-2"></i>
            <h4>{{ stats.tickets.open }}</h4>
            <small class="text-muted">Tickets Ouverts</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
            <h4>{{ stats.tickets.inProgress }}</h4>
            <small class="text-muted">En Cours</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
            <h4>{{ stats.tickets.resolved }}</h4>
            <small class="text-muted">Résolus</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-exclamation-triangle fa-2x text-danger mb-2"></i>
            <h4>{{ stats.tickets.urgent }}</h4>
            <small class="text-muted">Urgents</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des tickets récents -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-list me-2"></i>Tickets Récents</h5>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                <tr>
                  <th>ID Ticket</th>
                  <th>Sujet</th>
                  <th>Client</th>
                  <th>Priorité</th>
                  <th>Statut</th>
                  <th>Assigné à</th>
                  <th>Dernière MAJ</th>
                  <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let ticket of recentTickets; trackBy: trackByTicketId">
                  <td>
                    <span class="fw-bold">#{{ ticket.ticketNumber }}</span>
                  </td>
                  <td>{{ ticket.title }}</td>
                  <td>{{ ticket.createdBy.name || 'N/A' }}</td>
                  <td>
                    <span class="badge" [ngClass]="getPriorityBadgeClass(ticket.priority)">
                      {{ ticket.priority | titlecase }}
                    </span>
                  </td>
                  <td>
                    <span class="badge" [ngClass]="getStatusBadgeClass(ticket.status)">
                      {{ ticket.status | titlecase }}
                    </span>
                  </td>
                  <td>{{ ticket.assignedTo || 'Non assigné' }}</td>
                  <td>{{ ticket.updatedAt | date:'short':'fr-FR' }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" (click)="viewTicket(ticket._id)">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" (click)="editTicket(ticket._id)">
                      <i class="fas fa-edit"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
            <div *ngIf="recentTickets.length === 0" class="text-center py-4">
              <i class="fas fa-ticket-alt fa-2x text-muted mb-3"></i>
              <p class="text-muted">Aucun ticket récent à afficher.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div *ngIf="selectedView === 'activites'" class="activites-view">
    <div class="row mb-4">
      <!-- Statistiques des activites -->
      <div class="col-md-4 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-times-circle fa-2x text-info mb-2"></i>
            <h4>{{ stats.activities.todayActivities }}</h4>
            <small class="text-muted">Aujourd'hui</small>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
            <h4>{{ stats.activities.total }}</h4>
            <small class="text-muted">Sur la periode</small>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card text-center">
          <div class="card-body">
            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
            <h4 *ngFor="let us of stats.activities.mostActiveUsers" >{{ us.name +' - '+(us.count ?? '') }}</h4>
            <small class="text-muted">Utilisateurs les plus actifs</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Liste des activites récents -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-list me-2"></i>Activités Récents</h5>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-12">
                <app-activity-timeline
                  [activites]="recentActivities"
                  [usersInfo]="usersInfo">
                </app-activity-timeline>
                <div *ngIf="recentActivities.length === 0" class="p-3 text-center text-muted">
                  <p class="mb-0">Aucune activité récente à afficher.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue analytiques avancées -->
  <div *ngIf="selectedView === 'analytics'" class="analytics-view">
    <div class="row mb-4">
      <!-- Métriques avancées -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-header">
            <h5><i class="fas fa-chart-area me-2"></i>Analyse des Tendances</h5>
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeAnalyticsTab === 'performance'"
                        (click)="setActiveAnalyticsTab('performance')">
                  Performance
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeAnalyticsTab === 'customers'"
                        (click)="setActiveAnalyticsTab('customers')">
                  Clients
                </button>
              </li>
              <li class="nav-item">
                <button class="nav-link" [class.active]="activeAnalyticsTab === 'products'"
                        (click)="setActiveAnalyticsTab('products')">
                  Produits
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="chart-container" style="height: 400px; position: relative;">
              <canvas #analyticsChart></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">
            <h5><i class="fas fa-tachometer-alt me-2"></i>KPIs Clés</h5>
          </div>
          <div class="card-body">
            <div class="kpi-item mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Taux de conversion</span>
                <span class="fw-bold text-primary">{{ analyticsData.conversionRate }}%</span>
              </div>
              <div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar bg-primary" [style.width.%]="analyticsData.conversionRate"></div>
              </div>
            </div>

            <div class="kpi-item mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Satisfaction client</span>
                <span class="fw-bold text-success">{{ analyticsData.customerSatisfaction }}%</span>
              </div>
              <div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar bg-success" [style.width.%]="analyticsData.customerSatisfaction"></div>
              </div>
            </div>

            <div class="kpi-item mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Temps de réponse moyen</span>
                <span class="fw-bold text-info">{{ analyticsData.avgResponseTime }}h</span>
              </div>
            </div>

            <div class="kpi-item mb-3">
              <div class="d-flex justify-content-between align-items-center">
                <span class="text-muted">Taux de rétention</span>
                <span class="fw-bold text-warning">{{ analyticsData.retentionRate }}%</span>
              </div>
              <div class="progress mt-1" style="height: 4px;">
                <div class="progress-bar bg-warning" [style.width.%]="analyticsData.retentionRate"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
