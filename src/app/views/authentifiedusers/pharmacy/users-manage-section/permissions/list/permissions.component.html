<div class="permissions-management-container">
  <!-- Header -->
  <div class="page-header">
    <span class="h1-badge">Permissions</span>
    <div class="header-actions">
        <div class="btn-group me-2">
          <button class="btn"
                  [ngClass]="viewMode === 'list' ? 'btn-primary' : 'btn-outline-primary'"
                  (click)="toggleViewMode()"
                  title="Vue liste"
                  style="margin-right: 10px;">
            <i class="fas fa-list"></i>
          </button>
          <button class="btn"
                  [ngClass]="viewMode === 'matrix' ? 'btn-primary' : 'btn-outline-primary'"
                  (click)="toggleViewMode()"
                  title="Vue matrice">
            <i class="fas fa-th"></i>
          </button>
        </div>
<!--        <div class="btn-group">-->
<!--          <button class="btn btn-outline-primary"-->
<!--                  (click)="openGroupManagementModal()"-->
<!--                  data-bs-toggle="modal"-->
<!--                  data-bs-target="#groupManagementModal"-->
<!--                  *ngIf="permissions_.manageGroups">-->
<!--            <i class="fas fa-users-cog"></i> Groupes-->
<!--          </button>-->
<!--          <button class="btn btn-outline-success"-->
<!--                  (click)="openPermissionModal()"-->
<!--                  data-bs-toggle="modal"-->
<!--                  data-bs-target="#permissionModal"-->
<!--                  *ngIf="permissions_.editPermissions">-->
<!--            <i class="fas fa-key"></i> Permissions-->
<!--          </button>-->
<!--        </div>-->
  </div>
  </div>

  <!-- Navigation Tabs -->
  <div class="tabs-section">
    <ul class="nav nav-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [ngClass]="activeTab === 'users' ? 'active' : ''"
                (click)="switchTab('users')">
          <i class="fas fa-users"></i> Utilisateurs
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [ngClass]="activeTab === 'groups' ? 'active' : ''"
                (click)="switchTab('groups')">
          <i class="fas fa-users-cog"></i> Groupes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [ngClass]="activeTab === 'permissions' ? 'active' : ''"
                (click)="switchTab('permissions')">
          <i class="fas fa-key"></i> Permissions
        </button>
      </li>
    </ul>
  </div>

  <!-- Filters Section -->
  <div class="filters-section" *ngIf="activeTab === 'users'">
    <div class="row">
      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
          <input type="text"
                 class="form-control"
                 placeholder="Rechercher un utilisateur..."
                 [(ngModel)]="searchTerm">
<!--                 (keyup)="onSearch($event)"-->
        </div>
      </div>
      <div class="col-md-2">
        <select class="form-select"
                [(ngModel)]="selectedGroup"
                (change)="onGroupFilterChange()">
          <option value="">Tous les groupes</option>
          <option *ngFor="let group of groupOptions" [value]="group.value">
            {{ group.label }}
          </option>
        </select>
      </div>
      <div class="col-md-2">
        <div class="form-check mt-2">
          <input class="form-check-input"
                 type="checkbox"
                 [(ngModel)]="showOnlyWithChanges"
                 (change)="filterUsers()">
          <label class="form-check-label">
            Modifications en attente
          </label>
        </div>
      </div>
      <div class="col-md-3">
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm"
                  (click)="openBulkPermissionModal()"
                  data-bs-toggle="modal"
                  data-bs-target="#bulkPermissionModal"
                  *ngIf="permissions_.assignPermissions && selectedUsers.size > 0">
            <i class="fas fa-cogs"></i> Actions en lot ({{ selectedUsers.size }})
          </button>
          <span class="badge bg-warning" *ngIf="hasUserChanges()">
            {{ getUsersWithChanges() }} modification(s) en attente
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab Content -->
  <div class="tab-content">

    <!-- Users Tab -->
    <div class="tab-pane" [ngClass]="activeTab === 'users' ? 'active show' : ''">
      <div class="users-permissions-section" *ngIf="!isLoading;">

        <!-- List View -->
        <div class="card" *ngIf="viewMode === 'list'">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Permissions des Utilisateurs</h5>
              <div class="form-check">
                <input class="form-check-input"
                       type="checkbox"
                       [checked]="selectAll"
                       (change)="toggleSelectAll()">
                <label class="form-check-label">Tout sélectionner</label>
              </div>
            </div>
          </div>

          <div class="card-body p-0">
            <div class="table-responsive" *ngIf="userPermissions.length > 0; else noUsersTemplate">
              <table class="table table-hover mb-0">
                <thead class="table-header">
                <tr>
                  <th width="40">
                    <div class="form-check">
                      <input class="form-check-input"
                             type="checkbox"
                             [checked]="selectAll"
                             (change)="toggleSelectAll()">
                    </div>
                  </th>
                  <th>Utilisateur</th>
                  <th>Groupes actuels</th>
                  <th>Permissions héritées</th>
                  <th>Statut</th>
                  <th width="200">Actions</th>
                </tr>
                </thead>
                <tbody>
                <ng-container *ngFor="let userView of userPermissions; trackBy: trackByUserId">
                  <!-- Main user row -->
                  <tr class="user-row" [ngClass]="{'table-warning': userView.hasChanges}">
                    <td>
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               [checked]="isUserSelected(userView.user._id!)"
                               (change)="toggleUserSelection(userView.user._id!)">
                      </div>
                    </td>

                    <td>
                      <div class="user-info">
                        <div class="d-flex align-items-center">
                          <div class="user-avatar-container me-2">
                            <img *ngIf="userView.user.photoURL"
                                 [src]="userView.user.photoURL"
                                 [alt]="userView.user.getFullName()"
                                 class="user-avatar">
                            <div *ngIf="!userView.user.photoURL" class="avatar-placeholder">
                              {{ userView.user.getInitials() }}
                            </div>
                          </div>
                          <div>
                            <div class="user-name">{{ userView.user.getFullName() }}</div>
                            <small class="text-muted">{{ userView.user.email }}</small>
                          </div>
                        </div>
                      </div>
                    </td>

                    <td>
                      <div class="groups-container">
                          <span *ngFor="let group of userView.currentGroups; let i = index"
                                class="badge me-1 mb-1"
                                [ngClass]="getGroupBadgeClass(group.plateform)">
                            {{ group.name }}
                          </span>
                        <span *ngIf="userView.currentGroups.length === 0" class="text-muted">
                            Aucun groupe
                          </span>
                      </div>
                    </td>

                    <td> <span class="badge bg-info"> {{ userView.inheritedPermissions.length }} permission(s) </span> </td>
                    <td>
                        <span class="badge"  [ngClass]="userView.user.isActive() ? 'bg-success' : 'bg-danger'">
                          {{ userView.user.isActive() ? 'Actif' : 'Inactif' }}
                        </span>
                      <span class="badge bg-warning ms-1" *ngIf="userView.hasChanges"> Modifié </span>
                    </td>

                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-outline-primary"  (click)="toggleUserExpansion(userView)"  [title]="userView.isExpanded ? 'Réduire' : 'Développer'">
                          <i class="fas"  [ngClass]="userView.isExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                        </button>

                        <button class="btn btn-sm btn-success ms-1"
                                (click)="saveUserPermissions(userView)"
                                *ngIf="userView.hasChanges && permissions_.assignPermissions"
                                title="Sauvegarder">
                          <i class="fas fa-save"></i>
                        </button>

                        <button class="btn btn-sm btn-secondary ms-1"
                                (click)="cancelUserChanges(userView)"
                                *ngIf="userView.hasChanges"
                                title="Annuler">
                          <i class="fas fa-times"></i>
                        </button>
                      </div>
                    </td>
                  </tr>

                  <!-- Expanded details row -->
                  <tr *ngIf="userView.isExpanded" class="expanded-row">
                    <td colspan="6">
                      <div class="expanded-content p-3">
                        <div class="row">
                          <!-- Current Groups -->
                          <div class="col-md-6">
                            <h6>Groupes actuels</h6>
                            <div class="groups-list">
                              <div *ngFor="let group of userView.currentGroups"
                                   class="group-item d-flex justify-content-between align-items-center mb-2">
                                  <span class="badge" [ngClass]="getGroupBadgeClass(group.plateform)">
                                    {{ group.name }} ({{ group.plateform }})
                                  </span>
                                <button class="btn btn-sm btn-outline-danger"
                                        (click)="removeGroupFromUser(userView, group._id!)"
                                        *ngIf="permissions_.assignPermissions">
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                              <div *ngIf="userView.currentGroups.length === 0" class="text-muted">
                                Aucun groupe assigné
                              </div>
                            </div>
                          </div>

                          <!-- Available Groups -->
                          <div class="col-md-6" *ngIf="permissions_.assignPermissions">
                            <h6>Ajouter des groupes</h6>
                            <div class="available-groups">
                              <select class="form-select mb-2"
                                      [ngModel]="userView.pendingGroups[0]"
                                      (change)="addGroupToUser(userView, $event);">
                                <option value="">Sélectionner un groupe...</option>
                                <option *ngFor="let group of userView.availableGroups"
                                        [value]="group._id">
                                  {{ group.name }} ({{ group.plateform }})
                                </option>
                              </select>

                              <!-- Pending groups -->
                              <div *ngIf="userView.pendingGroups.length > 0">
                                <h6 class="text-warning">Groupes à ajouter:</h6>
                                <div *ngFor="let groupId of userView.pendingGroups"
                                     class="badge bg-warning me-1">
<!--                                  {{ (groups.f(): '_id': groupId)?.[0]?.name }}-->
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Inherited Permissions -->
                        <div class="row mt-3">
                          <div class="col-12">
                            <h6>Permissions héritées des groupes</h6>
                            <div class="permissions-grid">
                              <div *ngFor="let permission of userView.inheritedPermissions"
                                   class="permission-item">
                                <div class="card card-sm">
                                  <div class="card-body p-2">
                                    <h6 class="card-title mb-1">{{ permission.module }}</h6>
                                    <div class="permission-badges">
                                        <span *ngFor="let perm of permission.permissions"
                                              class="badge bg-secondary me-1 mb-1">
                                          {{ perm }}
                                        </span>
                                    </div>
                                    <small class="text-muted">
                                      {{ getPermissionDescription(permission) }}
                                    </small>
                                  </div>
                                </div>
                              </div>
                              <div *ngIf="userView.inheritedPermissions.length === 0"
                                   class="text-muted">
                                Aucune permission héritée
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
                </tbody>
              </table>
            </div>

            <ng-template #noUsersTemplate>
              <div class="no-data-container">
                <div class="no-data-content">
                  <i class="fas fa-users fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">Aucun utilisateur trouvé</h5>
                  <p class="text-muted">Aucun utilisateur ne correspond à vos critères.</p>
                </div>
              </div>
            </ng-template>
          </div>

          <!-- Pagination -->
          <div class="card-footer" *ngIf="totalPages > 1">
            <div class="d-flex justify-content-between align-items-center">
              <div class="pagination-info">
                Affichage de {{ (currentPage - 1) * itemsPerPage + 1 }} à
                {{ Math.min(currentPage * itemsPerPage, totalUsers) }} sur {{ totalUsers }} utilisateurs
              </div>

              <nav aria-label="Pagination">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" (click)="onPageChange(currentPage - 1)" [disabled]="currentPage === 1">
                      <i class="fas fa-chevron-left"></i>
                    </button>
                  </li>

                  <li *ngFor="let page of getPaginationArray()"
                      class="page-item" [class.active]="page === currentPage">
                    <button class="page-link" (click)="onPageChange(page)">{{ page }}</button>
                  </li>

                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <button class="page-link" (click)="onPageChange(currentPage + 1)" [disabled]="currentPage === totalPages">
                      <i class="fas fa-chevron-right"></i>
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- Matrix View -->
        <div class="permissions-matrix" *ngIf="viewMode === 'matrix'">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">Matrice des Permissions</h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-bordered table-sm">
                  <thead>
                  <tr>
                    <th class="sticky-col">Utilisateur</th>
                    <th *ngFor="let group of groups; trackBy: trackByGroupId"
                        class="text-center group-header"
                        [ngClass]="getGroupBadgeClass(group.plateform)">
                      {{ group.name }}
                    </th>
                  </tr>
                  </thead>
                  <tbody>
                  <tr *ngFor="let userView of userPermissions; trackBy: trackByUserId">
                    <td class="sticky-col user-cell">
                      <div class="user-info">
                        <div class="user-name">{{ userView.user.getFullName() }}</div>
                        <small class="text-muted">{{ userView.user.email }}</small>
                      </div>
                    </td>
                    <td *ngFor="let group of groups; trackBy: trackByGroupId"
                        class="text-center permission-cell">
                      <div class="form-check d-flex justify-content-center">
                        <input class="form-check-input"
                               type="checkbox"
                               [checked]="checkPermission(userView, group)"
                               (change)="checkPermission(userView, group) ?
                                          removeGroupFromUser(userView, group._id!) :
                                          addGroupToUser(userView, group._id!)"
                               [disabled]="!permissions_.assignPermissions">
                      </div>
                    </td>
                  </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Groups Tab -->
    <div class="tab-pane" [ngClass]="activeTab === 'groups' ? 'active show' : ''">
      <div class="groups-management-section">
        <div class="row">
          <div class="col-md-12">
            <div class="card">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Liste des Groupes</h5>
                </div>
              </div>

              <div class="card-body">
                <div class="row" *ngIf="permissions_.viewGroup">
                  <div class="col-md-12">
                    <div class="row">
                      <div class="col-md-{{ showGroupPermission ? 4 : 12 }}">
                        <div class="row">
                          <div class="col-md-{{ showGroupPermission ? 12 : 4 }}" *ngFor="let group of groups; trackBy: trackByGroupId" [style.border-color]="!(currentGroup != null && currentGroup._id == group._id) ? '#1e7e34' : '#212529'" >
                            <div class="card group-card mb-3">
                              <div class="card-header" [ngClass]="getGroupBadgeClass(group.plateform)">
                                <div class="d-flex justify-content-between align-items-center text-white">
                                  <h6 class="mb-0">{{ group.name }}</h6>
                                  <span class="badge badge-light" *ngIf=" checkInGroup(group._id)" >Vous etes membre</span>
                                  <span class="badge badge-light" *ngIf="permissions_.manageGroups">
                                    <span
                                      [ngbTooltip]="messEditGroup(group._id)"
                                      (click)="updateGroup(group)"
                                      [style.font-size.px]="20"
                                      [style.margin-right.px]="10"
                                      [style.color]="checkInGroup(group._id) ? '#ff6b6b' : '#ff9800'"
                                    >
                                      <i class="fas" [ngClass]="checkInGroup(group._id) ? 'fa-face-angry' : 'fa-face-grin-hearts'"></i>
                                    </span>
                                    <span (click)="openGroupMembersModal(group)" style="font-size: 20px;"> <i class="fas fa-users-between-lines"></i> </span>
                                  </span>
                                </div>
                              </div>

                              <div class="card-body">
                                <p class="card-text">{{ group.description || 'Aucune description' }}</p>
                                <div class="mb-2">
                                  <small class="text-muted">Code:</small>
                                  <span class="badge bg-secondary ms-1">{{ group.code }}</span>
                                </div>

                                <div class="mb-2">
                                  <small class="text-muted">Permissions:</small>
                                  <span class="badge bg-info ms-1">{{ group.permissions.length }}</span>
                                </div>
                                <div class="mb-3">
                                  <small class="text-muted">Statut:</small>
                                  <span class="badge ms-1" [ngClass]="group.isActive ? 'bg-success' : 'bg-danger'"></span>
                                </div>
                                <div class="mb-3">
                                  <button class="btn btn-sm btn-default" (click)="showGroupPermission=!(currentGroup != null && currentGroup._id == group._id); currentGroup = group;" >
                                    <i class="fas {{ showGroupPermission && currentGroup != null && currentGroup._id == group._id ? 'fa-arrow-down' : 'fa-arrow-right' }} "></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-8" [style.display]="showGroupPermission ? 'block' : 'none'" *ngIf="currentGroup">
                        <div class="row mt-3">
                          <div class="col-12">
                            <h6>Permissions gu groupe </h6>
                            <div class="permissions-grid">
                              <div *ngFor="let permission of currentGroup.permissions"
                                   class="permission-item">
                                <div class="card card-sm">
                                  <div class="card-body p-2">
                                    <h6 class="card-title mb-1">{{ permission.module }}</h6>
<!--                                    <div class="permission-badges">-->
<!--                                        <span *ngFor="let perm of permission.permissions"-->
<!--                                              class="badge bg-secondary me-1 mb-1">-->
<!--                                          {{ perm }}-->
<!--                                        </span>-->
<!--                                    </div>-->
                                    <small class="text-muted">
                                      {{ getPermissionDescription(permission) }}
                                    </small>
                                  </div>
                                </div>
                              </div>
                              <div *ngIf="currentGroup.permissions.length === 0"
                                   class="text-muted">
                                Aucune permission dans ce groupe
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Permissions Tab -->
    <div class="tab-pane" [ngClass]="activeTab === 'permissions' ? 'active show' : ''">
      <div class="permissions-management-section">
        <div class="card">
          <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Gestion des Permissions</h5>
            </div>
          </div>

          <div class="card-body">
            <!-- Filters -->
            <div class="row mb-3">
              <div class="col-md-4">
                <select class="form-select" [(ngModel)]="selectedModule">
                  <option *ngFor="let module of moduleOptions" [value]="module.value">
                    {{ module.label }}
                  </option>
                </select>
              </div>
            </div>

            <!-- Permissions by Module -->
            <div class="accordion" id="permissionsAccordion">
              <div class="accordion-item" *ngFor="let module of permissionModules; let i = index">
                <h2 class="accordion-header" [id]="'heading' + i">
                  <button class="accordion-button"
                          [class.collapsed]="!module.isExpanded"
                          type="button"
                          (click)="module.isExpanded = !module.isExpanded">
                    <strong>{{ module.module }}</strong>
                    <span class="badge bg-primary ms-2">{{ module.permissions.length }}</span>
                  </button>
                </h2>

                <div class="accordion-collapse collapse"
                     [class.show]="module.isExpanded"
                     [id]="'collapse' + i">
                  <div class="accordion-body">
                    <div class="row">
                      <div class="col-md-6" *ngFor="let permission of module.permissions; trackBy: trackByPermissionId">
                        <div class="card permission-card mb-3">
                          <div class="card-body">
                            <h6 class="card-title">
                              {{ permission.label || permission.module }}
                              <span class="badge ms-2" [ngClass]="getGroupBadgeClass(permission.plateform)">
                                {{ permission.plateform }}
                              </span>
                            </h6>

                            <p class="card-text text-muted small">
                              {{ getPermissionDescription(permission) }}
                            </p>

                            <div class="permission-actions">
                              <strong>Actions:</strong>
                              <div class="mt-1">
                                <span *ngFor="let perm of permission.permissions"
                                      class="badge bg-secondary me-1 mb-1">
                                  {{ perm }}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #bulkPermissionModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="bulkPermissionModalLabel">
      <i class="fas fa-cogs"></i> Actions en lot sur les permissions
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
      <form [formGroup]="bulkPermissionForm" (ngSubmit)="executeBulkPermissions()">
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle"></i>
            Cette action sera appliquée à {{ selectedUsers.size }} utilisateur(s) sélectionné(s).
          </div>

          <div class="mb-3">
            <label for="action" class="form-label">Action à exécuter <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="action"
                    [class.is-invalid]="isFieldInvalid(bulkPermissionForm, 'action')">
              <option value="">Sélectionner une action</option>
              <option value="add_groups">Ajouter des groupes</option>
              <option value="remove_groups">Retirer des groupes</option>
              <option value="replace_groups">Remplacer les groupes</option>
              <option value="add_permissions">Ajouter des permissions</option>
              <option value="remove_permissions">Retirer des permissions</option>
            </select>
            <div class="invalid-feedback">{{ getFieldError(bulkPermissionForm, 'action') }}</div>
          </div>

          <div class="mb-3" *ngIf="bulkPermissionForm.get('action')?.value?.includes('groups')">
            <label class="form-label">Groupes cibles</label>
            <select2 multiple="multiple" class="form-control" formControlName="newGroups"
                     [data]="groupOptions">
            </select2>
          </div>

<!--          <div class="mb-3" *ngIf="bulkPermissionForm.get('action')?.value?.includes('permissions')">-->
<!--            <label class="form-label">Permissions cibles</label>-->
<!--            <select2 multiple="multiple" class="form-control" formControlName="newPermissions"-->
<!--                     [data]="moduleOptions">-->
<!--            </select2>-->
<!--          </div>-->
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" (click)="closeModal()">Annuler</button>
          <button type="submit" class="btn btn-primary" [disabled]="!bulkPermissionForm.valid || isLoading">
            <i class="fas fa-check"></i> Exécuter l'action
          </button>
        </div>
      </form>
  </div>
</ng-template>
<!-- Template du modal de gestion des membres -->
<ng-template #groupMembersModalTemplate let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="groupMembersModalLabel">
      <i class="fas fa-users"></i> Gestion des membres - {{ currentGroup?.name }}
    </h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body">
    <!-- Informations du groupe -->
    <div class="card mb-4">
      <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Informations du groupe</h6>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <p><strong>Nom :</strong> {{ currentGroup?.name }}</p>
            <p><strong>Code :</strong> {{ currentGroup?.code }}</p>
          </div>
          <div class="col-md-6">
            <p><strong>Statut :</strong>
              <span class="badge" [class]="currentGroup?.isActive ? 'bg-success' : 'bg-danger'">
                {{ currentGroup?.isActive ? 'Actif' : 'Inactif' }}
              </span>
            </p>
          </div>
        </div>
        <p><strong>Description :</strong> {{ currentGroup?.description || 'Aucune description' }}</p>
      </div>
    </div>

    <!-- Section d'ajout de membres -->
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-user-plus"></i> Ajouter des membres</h6>
      </div>
      <div class="card-body">
        <form [formGroup]="addMemberForm" (ngSubmit)="addMemberToGroup()">
          <div class="row">
            <div class="col-md-8">
              <select2 class="form-control" formControlName="selectedUsers"
                 [data]="availableUsers"
                 multiple="multiple"
                 placeholder="Rechercher et sélectionner des utilisateurs...">
              </select2>
              <small class="form-text text-muted">
                Sélectionnez un ou plusieurs utilisateurs à ajouter au groupe
              </small>
            </div>
            <div class="col-md-4">
              <button type="submit" class="btn btn-primary w-100"
                      [disabled]="!addMemberForm.valid || isAddingMembers">
                <i class="fas fa-plus"></i>
                <span *ngIf="!isAddingMembers">Ajouter</span>
                <span *ngIf="isAddingMembers">
                  <i class="fas fa-spinner fa-spin"></i> Ajout...
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Liste des membres actuels -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0">
          <i class="fas fa-users"></i> Membres actuels
          <span class="badge bg-primary">{{ groupMembers.length }}</span>
        </h6>
        <div class="input-group" style="width: 300px;">
          <input type="text" class="form-control form-control-sm"
                 placeholder="Rechercher un membre..."
                 [(ngModel)]="memberSearchTerm">
          <span class="input-group-text">
            <i class="fas fa-search"></i>
          </span>
        </div>
      </div>
      <div class="card-body p-0">
        <div *ngIf="isLoadingMembers" class="text-center p-4">
          <i class="fas fa-spinner fa-spin"></i> Chargement des membres...
        </div>

        <div *ngIf="!isLoadingMembers && filteredMembers.length === 0" class="text-center p-4 text-muted">
          <i class="fas fa-users-slash fa-2x mb-2"></i>
          <p>Aucun membre trouvé</p>
        </div>

        <div *ngIf="!isLoadingMembers && filteredMembers.length > 0" class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
            <tr>
              <th>Utilisateur</th>
              <th>Email</th>
              <th class="text-center">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let member of filteredMembers; trackBy: trackByMemberId">
              <td>
                <div class="d-flex align-items-center">
                  <div class="avatar-circle me-2">
                    {{ getInitials(member.name, member.surname) }}
                  </div>
                  <div>
                    <strong>{{ member.name }} {{ member.surname }}</strong>
                    <br>
                  </div>
                </div>
              </td>
              <td>{{ member.email }}</td>
              <td class="text-center">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-outline-info"
                          (click)="viewMemberDetails(member)"
                          title="Voir les détails">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button type="button" class="btn btn-outline-danger"
                          (click)="removeMemberFromGroup(member)"
                          [disabled]="isRemovingMember === member._id"
                          title="Retirer du groupe">
                    <i class="fas fa-user-minus" *ngIf="isRemovingMember !== member._id"></i>
                    <i class="fas fa-spinner fa-spin" *ngIf="isRemovingMember === member._id"></i>
                  </button>
                </div>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      <i class="fas fa-times"></i> Fermer
    </button>
    <button type="button" class="btn btn-primary" (click)="refreshMembers()">
      <i class="fas fa-sync-alt"></i> Actualiser
    </button>
  </div>
</ng-template>

<!--<ng-template #permissionModalTemplate let-modal>-->
<!--  <div class="modal-header">-->
<!--    <h5 class="modal-title" id="permissionModalLabel">-->
<!--      <i class="fas fa-key"></i> Créer une permission-->
<!--    </h5>-->
<!--    <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>-->
<!--  </div>-->
<!--  <div class="modal-body">-->
<!--    <form [formGroup]="permissionForm" (ngSubmit)="createPermission()">-->
<!--      <div class="modal-body">-->
<!--        <div class="row">-->
<!--          <div class="col-md-6">-->
<!--            <div class="mb-3">-->
<!--              <label for="module" class="form-label">Module <span class="text-danger">*</span></label>-->
<!--              <input type="text" class="form-control" formControlName="module"-->
<!--                     [class.is-valid]="isFieldValid(permissionForm, 'module')"-->
<!--                     [class.is-invalid]="isFieldInvalid(permissionForm, 'module')"-->
<!--                     placeholder="Ex: utilisateurs, produits, commandes">-->
<!--              <div class="invalid-feedback">{{ getFieldError(permissionForm, 'module') }}</div>-->
<!--              <small class="form-text text-muted">-->
<!--                Le nom du module (ex: utilisateurs, produits, commandes)-->
<!--              </small>-->
<!--            </div>-->
<!--          </div>-->
<!--          <div class="col-md-6">-->
<!--            <div class="mb-3">-->
<!--              <label for="platform" class="form-label">Plateforme <span class="text-danger">*</span></label>-->
<!--              <select class="form-select" formControlName="platform"-->
<!--                      [class.is-valid]="isFieldValid(permissionForm, 'platform')"-->
<!--                      [class.is-invalid]="isFieldInvalid(permissionForm, 'platform')">-->
<!--                <option value="">Sélectionner une plateforme</option>-->
<!--                <option value="Admin">Administration</option>-->
<!--                <option value="Pharmacy">Pharmacie</option>-->
<!--                <option value="Deliver">Livraison</option>-->
<!--              </select>-->
<!--              <div class="invalid-feedback">{{ getFieldError(permissionForm, 'platform') }}</div>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="mb-3">-->
<!--          <label for="label" class="form-label">Libellé</label>-->
<!--          <input type="text" class="form-control" formControlName="label"-->
<!--                 placeholder="Ex: Gestion des utilisateurs">-->
<!--          <small class="form-text text-muted">-->
<!--            Nom d'affichage de la permission-->
<!--          </small>-->
<!--        </div>-->

<!--        <div class="mb-3">-->
<!--          <label for="description" class="form-label">Description</label>-->
<!--          <textarea class="form-control" rows="2" formControlName="description"-->
<!--                    placeholder="Description de ce que permet cette permission..."></textarea>-->
<!--        </div>-->

<!--        <div class="mb-3">-->
<!--          <label class="form-label">Actions de permission <span class="text-danger">*</span></label>-->
<!--          <div class="permission-actions-container">-->
<!--            <div formArrayName="permissions">-->
<!--              <div *ngFor="let control of permissionControls.controls; let i = index"-->
<!--                   class="d-flex align-items-center mb-2">-->
<!--                <input type="text"-->
<!--                       class="form-control"-->
<!--                       [formControlName]="i"-->
<!--                       placeholder="Ex: view, create, edit, delete">-->
<!--                <button type="button"-->
<!--                        class="btn btn-outline-danger btn-sm ms-2"-->
<!--                        (click)="removePermissionControl(i)"-->
<!--                        [disabled]="permissionControls.length <= 1">-->
<!--                  <i class="fas fa-times"></i>-->
<!--                </button>-->
<!--              </div>-->
<!--            </div>-->

<!--            <button type="button"-->
<!--                    class="btn btn-outline-primary btn-sm"-->
<!--                    (click)="addPermissionControl()">-->
<!--              <i class="fas fa-plus"></i> Ajouter une action-->
<!--            </button>-->

<!--            <small class="form-text text-muted d-block mt-2">-->
<!--              Exemples d'actions: view, create, edit, delete, export, import-->
<!--            </small>-->
<!--          </div>-->
<!--        </div>-->

<!--        <div class="alert alert-info">-->
<!--          <i class="fas fa-info-circle"></i>-->
<!--          <strong>Convention de nommage:</strong> Les permissions seront générées sous la forme-->
<!--          <code>module.action</code> (ex: utilisateurs.view, utilisateurs.create)-->
<!--        </div>-->
<!--      </div>-->

<!--      <div class="modal-footer">-->
<!--        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>-->
<!--        <button type="submit" class="btn btn-primary" [disabled]="!permissionForm.valid || isLoading">-->
<!--          <i class="fas fa-save"></i> Créer la permission-->
<!--        </button>-->
<!--      </div>-->
<!--    </form>-->
<!--  </div>-->
<!--</ng-template>-->
