<!--<div class="order-management-container">-->
  <div class="stats-header">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <div>
        <h2 class="stats-title">
          <i class="fas fa-shop-lock me-2"></i>
          Commandes
        </h2>

        <p class="text-muted mb-0">
          Suivi en temps réel des commandes
          <small class="ms-2">
            <i class="fas fa-clock me-1"></i>
            Dernière mise à jour: {{ lastUpdated | date:'EEEE d MMMM yyyy, HH:mm':'fr' }}
          </small>
        </p>
      </div>

      <div class="d-flex align-items-center flex-wrap gap-2">
        <!-- Boutons d'action -->
        <div class="custom-dropdown" [class.open]="isPeriodDropdownOpen" #statusDropdownn>
          <button type="button"
                  class="btn btn-dropdown"
                  (click)="toggleStatusDropdown()">
                <span class="status-badge">
                  <i class="fas fa-calendar-alt me-1"></i>
                  {{ getPeriodLabel(selectedPeriod) }}
                </span>
            <i class="fas fa-chevron-down" [class.rotated]="isPeriodDropdownOpen"></i>
          </button>
          <ul class="dropdown-menu custom-dropdown-menu"
              [class.show]="isPeriodDropdownOpen">
            <li *ngFor="let option of optionsPeriodDatas">
              <button class="dropdown-item"
                      type="button"
                      [class.active]="selectedPeriod === option.value"
                      (click)="setDateIntervalFromPeriod(option.value); closeDropdown()">
              <span class="status-badge" [ngClass]="'status-' + option.value">
                {{ option.label }}
              </span>
              </button>
            </li>
          </ul>
        </div>
        <button class="btn btn-outline-primary btn-sm" (click)="refreshDashboard()" [disabled]="isLoading">
          <i class="fas fa-sync-alt" [ngClass]="{'fa-spin': isLoading}"></i>
          Actualiser
        </button>
        <button class="btn btn-outline-secondary btn-sm" *ngIf="permissions.exportOrders" (click)="exportOrdersList()">
          <i class="fas fa-download"></i>
          Exporter
        </button>
        <button class="btn btn-outline-secondary" (click)="clearFilters()">
          <i class="fas fa-filter"></i> Effacer filtres
        </button>
      </div>
    </div>
  </div>
  <div class="reviews-filters mb-4">
    <div class="row">
      <div class="col-md-2">
          <select class="form-select" [(ngModel)]="statusFilter" (change)="filterOrders()">
            <option value="">Tous les statuts</option>
            <option value="pending">En attente</option>
            <option value="confirmed">Confirmée</option>
            <option value="prescription_pending">En attente prescription</option>
            <option value="preparing">En préparation</option>
            <option value="ready_for_pickup">Prête pour retrait</option>
            <option value="out_for_delivery">En cours de livraison</option>
            <option value="delivered">Livrée</option>
            <option value="completed">Terminée</option>
            <option value="cancelled">Annulée</option>
            <option value="returned">Retournée</option>
            <option value="refunded">Remboursée</option>
          </select>
      </div>
      <div class="col-md-2">
  <!--      <div class="filter-group">-->
  <!--        <label>Paiement:</label>-->
          <select class="form-select" [(ngModel)]="paymentStatusFilter" (change)="filterOrders()">
            <option value="">Tous les paiements</option>
            <option value="pending">En attente</option>
            <option value="paid">Payé</option>
            <option value="failed">Échoué</option>
            <option value="refunded">Remboursé</option>
            <option value="partially_refunded">Partiellement remboursé</option>
          </select>
  <!--      </div>-->
      </div>
      <div class="col-md-2">
  <!--      <div class="filter-group">-->
  <!--        <label>Livraison:</label>-->
          <select class="form-select" [(ngModel)]="deliveryMethodFilter" (change)="filterOrders()">
            <option value="">Toutes les livraisons</option>
            <option value="home_delivery">Livraison à domicile</option>
            <option value="pickup">Retrait en pharmacie</option>
            <option value="express">Livraison express</option>
            <option value="scheduled">Livraison programmée</option>
          </select>
  <!--      </div>-->
      </div>
      <div class="col-md-2">
  <!--      <div class="filter-group">-->
  <!--        <label>Date début:</label>-->
          <input type="date" class="form-control" [(ngModel)]="dateFromFilter" (change)="filterOrders()">
  <!--      </div>-->
      </div>
      <div class="col-md-2">
  <!--      <div class="filter-group">-->
  <!--        <label>Date fin:</label>-->
          <input type="date" class="form-control" [(ngModel)]="dateToFilter" (change)="filterOrders()">
  <!--      </div>-->
      </div>
      <div class="col-md-2">
  <!--      <div class="filter-group">-->
  <!--        <label>Pharmacie:</label>-->
          <select class="form-select" [(ngModel)]="pharmacyFilter" (change)="filterOrders()">
            <option value="">Toutes les pharmacies</option>
            <option *ngFor="let pharmacy of pharmaciesListArray" [value]="pharmacy.value">{{pharmacy.label}}</option>
          </select>
  <!--      </div>-->
      </div>
    </div>
<!--    <div class="row">-->
<!--        <div class="col-md-6">-->
<!--          <div class="search-box">-->
<!--            <i class="fas fa-search"></i>-->
<!--            <input type="text"-->
<!--                   class="form-control"-->
<!--                   placeholder="Rechercher une commande..."-->
<!--                   [(ngModel)]="searchText"-->
<!--                   (keyup)="filterOrders()">-->
<!--          </div>-->
<!--        </div>-->
<!--    </div>-->
  </div>
  <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ errorMessage }}
    <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
  </div>

<div *ngIf="!isLoading" class="stats-content">
  <div *ngIf="!isLoading && filteredOrders.length === 0" class="empty-state">
    <i class="fas fa-star"></i>
    <h3>Aucun avis trouvé</h3>
    <p>{{ searchText || filteredOrders || statusFilter ? 'Aucune commande ne correspond à vos critères de recherche.' : 'Aucune commande disponible.' }}</p>
  </div>

  <div *ngIf="!isLoading && filteredOrders.length > 0" class="table-responsive">
    <table class="table table-hover reviews-table">
      <thead>
        <tr>
        <th>
          <div class="th-content" (click)="sort('orderNumber')">
            N° Commande
            <i class="fas" [ngClass]="getSortIcon('orderNumber')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('customer.firstName')">
            Client
            <i class="fas" [ngClass]="getSortIcon('customer.firstName')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('pharmacy.name')">
            Pharmacie
            <i class="fas" [ngClass]="getSortIcon('pharmacy.name')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('status')">
            Statut
            <i class="fas" [ngClass]="getSortIcon('status')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('payment.status')">
            Paiement
            <i class="fas" [ngClass]="getSortIcon('payment.status')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('totalAmount')">
            Montant
            <i class="fas" [ngClass]="getSortIcon('totalAmount')"></i>
          </div>
        </th>
        <th>Articles</th>
        <th>
          <div class="th-content" (click)="sort('deliveryInfo.method')">
            Livraison
            <i class="fas" [ngClass]="getSortIcon('deliveryInfo.method')"></i>
          </div>
        </th>
        <th>
          <div class="th-content" (click)="sort('orderDate')">
            Date commande
            <i class="fas" [ngClass]="getSortIcon('orderDate')"></i>
          </div>
        </th>
        <th>Actions</th>
      </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of getPaginatedOrders()">
        <td>
          <div class="order-info">
              <span class="order-number">
                <a [routerLink]="['/pharmacy/orders', order._id]">{{ order.orderNumber }}</a>
              </span>
          </div>
        </td>
        <td>
          <div class="customer-info">
            <span class="customer-name">{{ order.customer?.getFullName() || 'Client inconnu' }}</span>
            <small class="customer-email text-muted d-block">{{ order.customer?.email }}</small>
          </div>
        </td>
        <td>
          <span *ngIf="order.pharmacy">{{ order.pharmacy.name }}</span>
          <span *ngIf="!order.pharmacy" class="text-muted">—</span>
        </td>
        <td>
            <span class="status-badge" [ngClass]="order.getStatusBadgeClass()">
              {{ order.getStatusLabel() }}
            </span>
        </td>
        <td>
          <div class="payment-info">
              <span class="payment-status"
                    [ngClass]="{'text-success': order.payment.status === 'paid',
                                'text-warning': order.payment.status === 'pending',
                                'text-danger': order.payment.status === 'failed'}">
                {{ getPaymentStatusLabel(order.payment.status) }}
              </span>
            <small class="payment-method text-muted d-block">{{ getPaymentMethodLabel(order.payment.method) }}</small>
          </div>
        </td>
        <td>
          <span class="amount">{{ order.pharmacy.currency.formatAmount(order.totalAmount) }}</span>
          <small class="discount text-muted d-block" *ngIf="order.discountAmount > 0">
            -{{ order.pharmacy.currency.formatAmount(order.discountAmount) }}
          </small>
        </td>
        <td>
          <span class="items-count">{{ order.getTotalItems() }} article(s)</span>
          <small class="prescription-required text-warning d-block" *ngIf="order.requiresPrescription()">
            <i class="fas fa-prescription"></i> Ordonnance requise
          </small>
        </td>
        <td>
          <div class="delivery-info">
            <span class="delivery-method">{{ order.getDeliveryMethodLabel() }}</span>
            <small class="tracking text-muted d-block" *ngIf="order.deliveryInfo.trackingNumber">
              {{ order.deliveryInfo.trackingNumber }}
            </small>
          </div>
        </td>
        <td>{{ order.orderDate | date: 'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <div class="action-buttons">
            <button class="btn btn-outline-primary btn-sm me-1"
                    (click)="viewOrderDetails(order)"
                    title="Voir les détails">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-warning btn-sm me-1"
                    *ngIf="permissions.manageOrderStatus"
                    (click)="openUpdateStatusModal(order)"
                    title="Modifier le statut">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm"
                    *ngIf="permissions.deleteOrders && order.isCancellable()"
                    (click)="deleteOrder(order)"
                    title="Supprimer">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="!isLoading && filteredOrders.length > 0" class="d-flex justify-content-between align-items-center mt-3 pagination-wrapper">
    <div class="pagination-info">
      Affichage de {{paginationStart + 1}} à {{paginationEnd}} sur {{filteredOrders.length}} commandes
    </div>
    <nav aria-label="Page navigation">
      <ul class="pagination">
        <li class="page-item" [ngClass]="{'disabled': currentPage === 1}">
          <a class="page-link" href="javascript:void(0)" (click)="pageChanged(currentPage - 1)">Précédent</a>
        </li>
        <li class="page-item" *ngFor="let page of getPageNumbers()" [ngClass]="{'active': page === currentPage}">
          <a class="page-link" href="javascript:void(0)" (click)="pageChanged(page)">{{page}}</a>
        </li>
        <li class="page-item" [ngClass]="{'disabled': currentPage === totalPages}">
          <a class="page-link" href="javascript:void(0)" (click)="pageChanged(currentPage + 1)">Suivant</a>
        </li>
      </ul>
    </nav>
  </div>
  <ng-template #orderDetailsModal>
    <div class="modal-custom-order-info" *ngIf="selectedOrder">
      <div class="modal-header">
        <div class="d-flex align-items-center">
          <div class="order-header-icon me-3">
            <i class="fas fa-shopping-bag fa-2x text-primary"></i>
          </div>
          <div>
            <h4 class="modal-title mb-1">Commande #{{ selectedOrder?.orderNumber }}</h4>
            <div class="order-badges">
            <span class="badge" [ngClass]="(selectedOrder?.getStatusBadgeClass())">
              <i class="fas" [ngClass]="selectedOrder?.isDelivered() ? 'fa-check-circle' : 'fa-clock'"></i>
                {{ getStatusLabel(selectedOrder?.status!) }}
            </span>
              <span class="badge bg-info" *ngIf="selectedOrder?.requiresPrescription()">
              <i class="fas fa-prescription-bottle me-1"></i>Ordonnance requise
            </span>
            </div>
          </div>
        </div>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedOrder">
        <!-- Quick Info Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3 col-sm-6">
            <div class="info-card">
              <div class="info-icon bg-primary">
                <i class="fas fa-calendar"></i>
              </div>
              <div class="info-content">
                <small class="text-muted">Date de commande</small>
                <strong>{{ selectedOrder.orderDate | date: 'dd/MM/yyyy' }}</strong>
                <small class="text-muted d-block">{{ selectedOrder.orderDate | date: 'HH:mm' }}</small>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="info-card">
              <div class="info-icon bg-success">
                <i class="fas fa-shopping-cart"></i>
              </div>
              <div class="info-content">
                <small class="text-muted">Articles</small>
                <strong>{{ selectedOrder.getTotalItems() }}</strong>
                <small class="text-muted d-block">{{ selectedOrder.items.length }} produit(s)</small>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="info-card">
              <div class="info-icon bg-warning">
                <i class="fas fa-euro-sign"></i>
              </div>
              <div class="info-content">
                <small class="text-muted">Montant total</small>
                <strong>{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.totalAmount)}}</strong>
              </div>
            </div>
          </div>

          <div class="col-md-3 col-sm-6">
            <div class="info-card">
              <div class="info-icon bg-info">
                <i class="fas fa-truck"></i>
              </div>
              <div class="info-content">
                <small class="text-muted">Livraison</small>
                <strong>{{ selectedOrder.getDeliveryMethodLabel() }}</strong>
              </div>
            </div>
          </div>
        </div>
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs mb-3" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'general'"
                    (click)="orderModalTab = 'general'"
                    type="button">
              <i class="fas fa-info-circle me-2"></i>
              Général
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'items'"
                    (click)="orderModalTab = 'items'"
                    type="button">
              <i class="fas fa-box me-2"></i>
              Articles ({{ selectedOrder.items.length }})
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'taxes'"
                    (click)="orderModalTab = 'taxes'"
                    type="button">
              <i class="fas fa-percentage me-2"></i>
              Taxes ({{ getTaxesNumber(selectedOrder) }})
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'payment'"
                    (click)="orderModalTab = 'payment'"
                    type="button">
              <i class="fas fa-credit-card me-2"></i>
              Paiement & Facturation
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'delivery'"
                    (click)="orderModalTab = 'delivery'"
                    type="button">
              <i class="fas fa-truck me-2"></i>
              Livraison
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    [class.active]="orderModalTab === 'notes'"
                    (click)="orderModalTab = 'notes'"
                    type="button">
              <i class="fas fa-sticky-note me-2"></i>
              Notes
            </button>
          </li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content">
          <!-- General Tab -->
          <div *ngIf="orderModalTab === 'general'" class="tab-pane fade show active">
            <div class="row">
              <!-- Informations Commande -->
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-receipt me-2 text-primary"></i>
                      Informations de commande
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label><i class="fas fa-hashtag me-2 text-primary"></i>Numéro de commande</label>
                      <p><code class="fs-6">{{ selectedOrder.orderNumber }}</code></p>
                    </div>

                    <div class="info-group">
                      <label><i class="fas fa-calendar me-2 text-primary"></i>Date de commande</label>
                      <p>{{ selectedOrder.orderDate | date: 'dd/MM/yyyy HH:mm' }}</p>
                    </div>

                    <div class="info-group">
                      <label><i class="fas fa-toggle-on me-2 text-success"></i>Statut</label>
                      <p>
                      <span [ngClass]="'badge bg-' + selectedOrder.getStatusBadgeClass()">
                        {{ selectedOrder.getStatusLabel() }}
                      </span>
                      </p>
                    </div>

                    <div class="info-group" *ngIf="selectedOrder.confirmedAt">
                      <label><i class="fas fa-check me-2 text-success"></i>Confirmée le</label>
                      <p>{{ selectedOrder.confirmedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
                    </div>

                    <div class="info-group" *ngIf="selectedOrder.completedAt">
                      <label><i class="fas fa-flag-checkered me-2 text-success"></i>Complétée le</label>
                      <p>{{ selectedOrder.completedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Informations Client & Pharmacie -->
              <div class="col-md-6">
                <div class="card mb-3">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-users me-2 text-info"></i>
                      Client & Pharmacie
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label><i class="fas fa-user me-2 text-info"></i>Client</label>
                      <p class="fw-bold">{{ selectedOrder.customer?.getFullName() }}</p>
                      <small class="text-muted d-block">{{ selectedOrder.customer?.email }}</small>
                      <small class="text-muted d-block" *ngIf="selectedOrder.customer?.defaultPhone">
                        {{ selectedOrder.customer.defaultPhone.digits }}
                      </small>
                    </div>

                    <div class="info-group" *ngIf="selectedOrder.pharmacy">
                      <label><i class="fas fa-store me-2 text-info"></i>Pharmacie</label>
                      <p class="fw-bold">{{ selectedOrder.pharmacy.name }}</p>
                      <small class="text-muted d-block" *ngIf="selectedOrder.pharmacy.email">
                        {{ selectedOrder.pharmacy.email }}
                      </small>
                    </div>

                    <div class="info-group" *ngIf="selectedOrder.customer?.hasAllergies()">
                      <label><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Allergies</label>
                      <p class="text-warning mb-0">
                        {{ selectedOrder.customer.medicalInfo.allergies.join(', ') }}
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Items Tab -->
          <div *ngIf="orderModalTab === 'items'" class="tab-pane fade show active">
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-shopping-cart me-2"></i>
                  Articles commandés
                </h6>
              </div>
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover mb-0">
                    <thead class="table-light">
                    <tr>
                      <th>Produit</th>
                      <th>Quantité</th>
                      <th>Prix unitaire</th>
                      <th>Taxes</th>
                      <th>Total</th>
                      <th>Ordonnance</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr *ngFor="let item of selectedOrder.items; let last = last">
                      <td>
                        <div class="product-info">
                          <span class="product-name fw-bold d-block">{{ item.product.name }}</span>
                          <small class="text-muted" *ngIf="item.product.sku">
                            SKU: {{ item.product.sku }}
                          </small>
                        </div>
                      </td>
                      <td class="align-middle">
                        <span class="badge bg-secondary">{{ item.quantity }}</span>
                      </td>
                      <td class="align-middle">{{ item.unitPrice | currency:'EUR':'symbol':'1.2-2' }}</td>
                      <td class="align-middle">
                        <small class="text-muted" *ngIf="item.applicableTaxes?.length">
                          {{ item.applicableTaxes.length }} taxe(s)
                        </small>
                        <small class="text-muted" *ngIf="!item.applicableTaxes?.length">—</small>
                      </td>
                      <td class="align-middle">
                        <strong>{{ item.totalPrice | currency:'EUR':'symbol':'1.2-2' }}</strong>
                      </td>
                      <td class="align-middle">
                      <span *ngIf="item.prescriptionRequired"
                            [ngClass]="{'text-success': item.prescriptionProvided, 'text-warning': !item.prescriptionProvided}">
                        <i class="fas" [ngClass]="{'fa-check-circle': item.prescriptionProvided, 'fa-exclamation-circle': !item.prescriptionProvided}"></i>
                        {{ item.prescriptionProvided ? 'Fournie' : 'Requise' }}
                      </span>
                        <span *ngIf="!item.prescriptionRequired" class="text-muted">—</span>
                      </td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Price Breakdown Card -->
            <div class="card mt-3">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-calculator me-2"></i>
                  Récapitulatif des montants
                </h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="price-breakdown-item mb-3">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Sous-total:</span>
                        <strong>{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.subtotal)}}</strong>
                      </div>
                    </div>

                    <div class="price-breakdown-item mb-3" *ngIf="selectedOrder.discountAmount > 0">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Remise:</span>
                        <span class="text-success">-{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.discountAmount) }}</span>
                      </div>
                    </div>

                    <div class="price-breakdown-item mb-3" *ngIf="selectedOrder.coupon.appliedDiscount > 0">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Coupon ({{ selectedOrder.coupon.code }}):</span>
                        <span class="text-success">-{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.coupon.appliedDiscount) }}</span>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="price-breakdown-item mb-3" *ngIf="selectedOrder.taxAmount > 0">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Taxes:</span>
                        <strong class="text-primary">{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.taxAmount) }}</strong>
                      </div>
                    </div>

                    <div class="price-breakdown-item mb-3" *ngIf="selectedOrder.shippingCost > 0">
                      <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Frais de livraison:</span>
                        <strong>{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.shippingCost) }}</strong>
                      </div>
                    </div>
                  </div>
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center mt-3">
                  <strong class="fs-5">Total à payer:</strong>
                  <strong class="fs-4 text-success">{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.totalAmount) }}</strong>
                </div>
              </div>
            </div>
          </div>
          <!-- Taxes Tab -->
          <div *ngIf="orderModalTab === 'taxes'" class="tab-pane fade show active">
            <div class="row">
              <!-- Recap Taxe et produit -->
              <div class="col-md-12">
                <div class="alert alert-info mt-3" *ngIf="getSelectedOderProduct().length > 0">
                  <i class="fas fa-info-circle me-2"></i>
                  <small>{{ getSelectedOderProduct().length }} produit(s) avec taxe(s) appliquée(s)</small>
                </div>
              </div>
              <div class="col-md-12" *ngFor="let item of selectedOrder.items">
                <div class="card mb-3 border-warning">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-percentage me-2"></i>
                      Taxe ({{ item.product.name }})
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row-div" *ngFor="let taxe of item.applicableTaxes">
                      <label class="fw-bold"><i class="fas fa-coins me-2 text-success"></i>{{ taxe.taxe.name }}</label>
                      <p class="fw-bold">{{ selectedOrder.pharmacy.currency.formatAmount(getProductTaxValue(item, taxe)) }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factures & Bons Fiscaux -->
            <div class="row" *ngIf="selectedOrder.invoice || selectedOrder.bonfiscal">
              <div class="col-md-6" *ngIf="selectedOrder.invoice">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-file-invoice me-2 text-primary"></i>
                      Facture
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label>Numéro de facture</label>
                      <p><code>{{ selectedOrder.invoice?.invoiceNumber }}</code></p>
                    </div>
                    <div class="info-group">
                      <label>Date d'émission</label>
                      <p>{{ selectedOrder.invoice?.createdAt | date: 'dd/MM/yyyy' }}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-primary w-100">
                      <i class="fas fa-download me-2"></i>
                      Télécharger
                    </button>
                  </div>
                </div>
              </div>

              <div class="col-md-6" *ngIf="selectedOrder.bonfiscal">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-receipt me-2 text-success"></i>
                      Bon Fiscal
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label>Numéro du bon</label>
                      <p><code>{{ selectedOrder.bonfiscal?.bonfiscalNumber }}</code></p>
                    </div>
                    <div class="info-group">
                      <label>Date d'émission</label>
                      <p>{{ selectedOrder.bonfiscal?.createdAt | date: 'dd/MM/yyyy' }}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-success w-100">
                      <i class="fas fa-download me-2"></i>
                      Télécharger
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Payment Tab -->
          <div *ngIf="orderModalTab === 'payment'" class="tab-pane fade show active">
            <div class="row">
              <!-- Information de Paiement -->
              <div class="col-md-12">
                <div class="alert alert-info mt-3" *ngIf="getSelectedOderProduct().length > 0">
                  <i class="fas fa-info-circle me-2"></i>
                  <small>{{ getSelectedOderProduct().length }} produit(s) avec taxe(s) appliquée(s)</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card mb-3 border-primary">
                  <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-credit-card me-2"></i>
                      Informations de paiement
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row-div">
                      <label class="fw-bold"><i class="fas fa-wallet me-2 text-primary"></i>Méthode de paiement</label>
                      <p class="fw-bold">{{ getPaymentMethodLabel(selectedOrder.payment.method) }}</p>
                    </div>

                    <div class="row-div">
                      <label class="fw-bold"><i class="fas fa-check-circle me-2 text-primary"></i>Statut du paiement</label>
                      <p>
                      <span [ngClass]="{
                        'text-success': selectedOrder.payment.status === 'paid',
                        'text-warning': selectedOrder.payment.status === 'pending',
                        'text-danger': selectedOrder.payment.status === 'failed'
                      }">
                        <i class="fas" [ngClass]="{
                          'fa-check-circle': selectedOrder.payment.status === 'paid',
                          'fa-clock': selectedOrder.payment.status === 'pending',
                          'fa-times-circle': selectedOrder.payment.status === 'failed'
                        }"></i>
                        {{ getPaymentStatusLabel(selectedOrder.payment.status) }}
                      </span>
                      </p>
                    </div>

                    <div class="row-div" *ngIf="selectedOrder.payment.transactionId">
                      <label class="fw-bold"><i class="fas fa-key me-2 text-primary"></i>ID Transaction</label>
                      <p><code>{{ selectedOrder.payment.transactionId }}</code></p>
                    </div>

                    <div class="row-div" *ngIf="selectedOrder.payment.paidAt">
                      <label class="fw-bold"><i class="fas fa-calendar-check me-2 text-success"></i>Payé le</label>
                      <p>{{ selectedOrder.payment.paidAt | date: 'dd/MM/yyyy HH:mm' }}</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Détails des taxes -->
              <div class="col-md-6">
                <div class="card mb-3 border-success">
                  <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                      <i class="fas fa-receipt me-2"></i>
                      Récapitulatif fiscal
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="row-div">
                      <label class="fw-bold"><i class="fas fa-coins me-2 text-success"></i>Montant HT</label>
                      <p class="fw-bold">{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.subtotal) }}</p>
                    </div>

                    <div class="row-div">
                      <label class="fw-bold"><i class="fas fa-percentage me-2 text-success"></i>Montant des taxes</label>
                      <p class="fw-bold text-primary">{{ selectedOrder.pharmacy.currency.formatAmount(selectedOrder.taxAmount) }}</p>
                    </div>

                    <div class="row-div">
                      <label class="fw-bold"><i class="fas fa-euro-sign me-2 text-success"></i>Montant TTC</label>
                      <p class="fw-bold text-success fs-5">{{ selectedOrder.pharmacy.currency.formatAmount((selectedOrder.subtotal + selectedOrder.taxAmount)) }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Factures & Bons Fiscaux -->
            <div class="row" *ngIf="selectedOrder.invoice || selectedOrder.bonfiscal">
              <div class="col-md-6" *ngIf="selectedOrder.invoice">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-file-invoice me-2 text-primary"></i>
                      Facture
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label>Numéro de facture</label>
                      <p><code>{{ selectedOrder.invoice?.invoiceNumber }}</code></p>
                    </div>
                    <div class="info-group">
                      <label>Date d'émission</label>
                      <p>{{ selectedOrder.invoice?.createdAt | date: 'dd/MM/yyyy' }}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-primary w-100">
                      <i class="fas fa-download me-2"></i>
                      Télécharger
                    </button>
                  </div>
                </div>
              </div>

              <div class="col-md-6" *ngIf="selectedOrder.bonfiscal">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">
                      <i class="fas fa-receipt me-2 text-success"></i>
                      Bon Fiscal
                    </h6>
                  </div>
                  <div class="card-body">
                    <div class="info-group">
                      <label>Numéro du bon</label>
                      <p><code>{{ selectedOrder.bonfiscal?.bonfiscalNumber }}</code></p>
                    </div>
                    <div class="info-group">
                      <label>Date d'émission</label>
                      <p>{{ selectedOrder.bonfiscal?.createdAt | date: 'dd/MM/yyyy' }}</p>
                    </div>
                    <button class="btn btn-sm btn-outline-success w-100">
                      <i class="fas fa-download me-2"></i>
                      Télécharger
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Delivery Tab -->
          <div *ngIf="orderModalTab === 'delivery'" class="tab-pane fade show active">
            <div class="card mb-3 border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="fas fa-map-marker-alt me-2"></i>
                  Adresse de livraison
                </h6>
              </div>
              <div class="card-body">
                <div class="address-box p-3 bg-light rounded mb-3">
                  <p class="mb-1 fw-bold">
                    {{ selectedOrder.deliveryInfo.address.firstName }}
                    {{ selectedOrder.deliveryInfo.address.lastName }}
                  </p>
                  <p class="mb-1">{{ selectedOrder.deliveryInfo.address.street }}</p>
                  <p class="mb-1">
                    {{ selectedOrder.deliveryInfo.address.postalCode }}
                    {{ selectedOrder.deliveryInfo.address.city }}
                  </p>
                  <p class="mb-0" *ngIf="selectedOrder.deliveryInfo.address.country">
                    {{ selectedOrder.deliveryInfo.address.country.name }}
                  </p>
                  <p class="text-muted mt-2 mb-0" *ngIf="selectedOrder.deliveryInfo.address.instructions">
                    <small><i class="fas fa-comment me-2"></i>{{ selectedOrder.deliveryInfo.address.instructions }}</small>
                  </p>
                </div>

                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="info-group">
                      <label><i class="fas fa-car me-2 text-info"></i>Mode de livraison</label>
                      <p class="fw-bold">{{ selectedOrder.getDeliveryMethodLabel() }}</p>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="info-group">
                      <label><i class="fas fa-calendar me-2 text-info"></i>Date prévue</label>
                      <p>
                        {{ selectedOrder.deliveryInfo.estimatedDeliveryDate ? (selectedOrder.deliveryInfo.estimatedDeliveryDate | date: 'dd/MM/yyyy') : '—' }}
                      </p>
                    </div>
                  </div>

                  <div class="col-md-6" *ngIf="selectedOrder.deliveryInfo.trackingNumber">
                    <div class="info-group">
                      <label><i class="fas fa-barcode me-2 text-info"></i>Numéro de suivi</label>
                      <p><code>{{ selectedOrder.deliveryInfo.trackingNumber }}</code></p>
                    </div>
                  </div>

                  <div class="col-md-6" *ngIf="selectedOrder.deliveryInfo.deliveryProvider">
                    <div class="info-group">
                      <label><i class="fas fa-building me-2 text-info"></i>Prestataire</label>
                      <p>{{ selectedOrder.deliveryInfo.deliveryProvider }}</p>
                    </div>
                  </div>

                  <div class="col-md-6" *ngIf="selectedOrder.deliveryInfo.actualDeliveryDate">
                    <div class="info-group">
                      <label><i class="fas fa-check-circle me-2 text-success"></i>Livré le</label>
                      <p>{{ selectedOrder.deliveryInfo.actualDeliveryDate | date: 'dd/MM/yyyy HH:mm' }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Return Info -->
            <div class="card" *ngIf="selectedOrder.returnInfo">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-undo me-2"></i>
                  Informations de retour
                </h6>
              </div>
              <div class="card-body">
                <div class="info-group">
                  <label><i class="fas fa-check me-2"></i>Retour possible</label>
                  <p>
                  <span [ngClass]="selectedOrder.returnInfo.isReturnable ? 'text-success' : 'text-danger'">
                    {{ selectedOrder.returnInfo.isReturnable ? 'Oui' : 'Non' }}
                  </span>
                  </p>
                </div>

                <div class="info-group" *ngIf="selectedOrder.returnInfo.isReturnable && selectedOrder.isDelivered()">
                  <label><i class="fas fa-calendar me-2"></i>Délai de rétractation</label>
                  <p>Jusqu'au {{ selectedOrder.getReturnDeadline() | date: 'dd/MM/yyyy' }}</p>
                </div>

                <div class="info-group" *ngIf="selectedOrder.returnInfo.refundStatus !== 'none'">
                  <label><i class="fas fa-money-bill-wave me-2"></i>Statut du remboursement</label>
                  <p>
                  <span [ngClass]="{
                    'badge bg-warning': selectedOrder.returnInfo.refundStatus === 'requested',
                    'badge bg-info': selectedOrder.returnInfo.refundStatus === 'approved',
                    'badge bg-success': selectedOrder.returnInfo.refundStatus === 'processed'
                  }">
                    {{ selectedOrder.returnInfo.refundStatus }}
                  </span>
                  </p>
                </div>
              </div>
            </div>
          </div>
          <!-- Notes Tab -->
          <div *ngIf="orderModalTab === 'notes'" class="tab-pane fade show active">
            <!-- Client Notes -->
            <div class="card mb-3" *ngIf="selectedOrder.clientNotes?.length">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-user-comment me-2 text-primary"></i>
                  Notes du client
                </h6>
              </div>
              <div class="card-body">
                <div *ngFor="let note of selectedOrder.clientNotes" class="note-item p-2 bg-light rounded mb-2">
                  <div class="d-flex justify-content-between mb-1">
                    <strong>{{ note.from.getFullName }}</strong>
                    <small class="text-muted">{{ note.updatedAt | date: 'dd/MM/yyyy HH:mm' }}</small>
                  </div>
                  <p class="mb-0">{{ note.note }}</p>
                </div>
              </div>
            </div>

            <!-- Pharmacy Notes -->
            <div class="card mb-3" *ngIf="selectedOrder.pharmacyNotes?.length">
              <div class="card-header bg-light">
                <h6 class="mb-0">
                  <i class="fas fa-store me-2 text-success"></i>
                  Notes de la pharmacie
                </h6>
              </div>
              <div class="card-body">
                <div *ngFor="let note of selectedOrder.pharmacyNotes" class="note-item p-2 bg-light rounded mb-2">
                  <div class="d-flex justify-content-between mb-1">
                    <strong>{{ note.from.getFullName ? note.from.getFullName() : note.from }}</strong>
                    <small class="text-muted">{{ note.updatedAt | date: 'dd/MM/yyyy HH:mm' }}</small>
                  </div>
                  <p class="mb-0">{{ note.note }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeModal()">Fermer</button>
      <button type="button" class="btn btn-warning"
              *ngIf="permissions.manageOrderStatus"
              (click)="closeModal(); openUpdateStatusModal(selectedOrder!)">
        <i class="fas fa-edit"></i> Modifier le statut
      </button>
    </div>
    </div>
  </ng-template>
</div>
