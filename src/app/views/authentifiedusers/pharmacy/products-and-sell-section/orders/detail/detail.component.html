<!-- Order not found -->
<div *ngIf="!isLoading && !order" class="text-center py-5">
  <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
  <h3>Commande introuvable</h3>
  <p class="text-muted">La commande demandée n'existe pas ou vous n'avez pas les permissions pour la voir.</p>
  <a (click)="goBack()" class="btn btn-primary">
    <i class="fas fa-arrow-left"></i> Retour à la liste
  </a>
</div>

<!-- Order details -->
<div *ngIf="!isLoading && order" class="order-detail-container">
  <!-- Header -->
  <div class="page-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h2 mb-1">Commande {{ order.orderNumber }}</h1>
        <div class="d-flex align-items-center gap-3">
          <span class="status-badge" [ngClass]="order.getStatusBadgeClass()">
            {{ order.getStatusLabel() }}
          </span>
          <small class="text-muted">
            <i class="fas fa-calendar"></i>
            {{ formatDate(order.orderDate) }}
          </small>
          <small class="text-muted" *ngIf="order.customer">
            <i class="fas fa-user"></i>
            <a href="javascript:void(0)" (click)="goToCustomerDetail()" class="text-decoration-none">
              {{ order.customer.getFullName() }}
            </a>
          </small>
        </div>

      </div>
    </div>
    <!-- Quick actions -->
    <div class="header-actions">
      <a (click)="goBack()" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Retour
      </a>
    </div>
  </div>


  <!--   Quick status actions -->
  <div class="quick-actions-bar mb-4" *ngIf="canUpdateStatus()">
    <div class="d-flex gap-2 flex-wrap">
      <button class="btn btn-sm btn-success mr-3"
              *ngIf="order.status === 'pending'"
              (click)="quickStatusUpdate('confirmed')"
              [disabled]="isSubmitting">
        <i class="fas fa-check"></i> Confirmer
      </button>
      <button class="btn btn-sm btn-outline-primary mr-3"
              *ngIf="order.status === 'confirmed'"
              (click)="quickStatusUpdate('preparing')"
              [disabled]="isSubmitting">
        <i class="fas fa-cogs"></i> En préparation
      </button>
      <button class="btn btn-sm btn-outline-primary mr-3"
              *ngIf="order.status === 'preparing'"
              (click)="quickStatusUpdate('ready_for_pickup')"
              [disabled]="isSubmitting">
        <i class="fas fa-check-circle"></i> Prêt
      </button>
      <button class="btn btn-sm btn-outline-warning mr-3"
              *ngIf="order.status === 'ready_for_pickup'"
              (click)="quickStatusUpdate('out_for_delivery')"
              [disabled]="isSubmitting">
        <i class="fas fa-truck"></i> Expédier
      </button>
      <button class="btn btn-sm btn-outline-success mr-3"
              *ngIf="order.status === 'out_for_delivery'"
              (click)="quickStatusUpdate('delivered')"
              [disabled]="isSubmitting">
        <i class="fas fa-check-double"></i> Livré
      </button>
      <button class="btn btn-sm btn-outline-danger mr-3"
              *ngIf="order.isCancellable()"
              (click)="quickStatusUpdate('cancelled')"
              [disabled]="isSubmitting">
        <i class="fas fa-times"></i> Annuler
      </button>
    </div>
  </div>

  <div class="order-lifecycle-container mb-4" *ngIf="!isLoading && order">
    <div class="card">
      <div class="card-header bg-light">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-route me-2"></i>
            Cycle de vie de la commande
          </h6>
          <div class="lifecycle-info">
            <span class="badge bg-primary">{{ getLifecycleStageLabel() }}</span>
            <small class="text-muted ms-2">
              Étape {{ getCurrentStageIndex() }}/{{ getTotalStages() }}
            </small>
          </div>
        </div>
      </div>
      <div class="card-body py-3">
        <!-- Progress bar container -->
        <div class="lifecycle-progress-container">
          <!-- Main progress bar -->
          <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-success"
                 role="progressbar"
                 [style.width.%]="getLifecycleProgress()"
                 [attr.aria-valuenow]="getLifecycleProgress()"
                 aria-valuemin="0"
                 aria-valuemax="100">
            </div>
          </div>

          <!-- Lifecycle stages -->
          <div class="lifecycle-stages">
            <div class="row text-center">
              <!-- Stage 1: Commande créée -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('created')"
                   [class.active]="isStageActive('created')">
                <div class="stage-icon">
                  <i class="fas fa-shopping-cart"></i>
                </div>
                <div class="stage-label">Commande</div>
                <div class="stage-date" *ngIf="order.orderDate">
                  {{ formatDate(order.orderDate) }}
                </div>
              </div>

              <!-- Stage 2: Validation/Prescription -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('validated')"
                   [class.active]="isStageActive('validated')">
                <div class="stage-icon">
                  <i class="fas" [ngClass]="order.requiresPrescription() ? 'fa-prescription' : 'fa-check-circle'"></i>
                </div>
                <div class="stage-label">
                  {{ order.requiresPrescription() ? 'Validation Rx' : 'Validation' }}
                </div>
                <div class="stage-date" *ngIf="order.confirmedAt">
                  {{ formatDate(order.confirmedAt) }}
                </div>
                <!-- Prescription status indicator -->
                <div class="prescription-indicator" *ngIf="order.requiresPrescription()">
                <span class="badge badge-sm"
                      [ngClass]="{'bg-success': allPrescriptionsProvided(), 'bg-warning': !allPrescriptionsProvided()}">
                  {{ getPrescriptionStatus() }}
                </span>
                </div>
              </div>

              <!-- Stage 3: Préparation -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('preparing')"
                   [class.active]="isStageActive('preparing')">
                <div class="stage-icon">
                  <i class="fas fa-pills"></i>
                </div>
                <div class="stage-label">Préparation</div>
                <div class="stage-date" *ngIf="getDateStatus('preparing')">
                  {{ formatDate(getDateStatus('preparing')) }}
                </div>
              </div>

              <!-- Stage 5: Prêt/Expédition -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('ready')"
                   [class.active]="isStageActive('ready')">
                <div class="stage-icon">
                  <i class="fas" [ngClass]="order.deliveryInfo.method === 'pickup' ? 'fa-store' : 'fa-truck'"></i>
                </div>
                <div class="stage-label">
                  {{ order.deliveryInfo.method === 'pickup' ? 'Retrait' : 'Expédition' }}
                </div>
                <div class="stage-date" *ngIf="getDateStatus('readyAt') || order.shippedAt">
                  {{ formatDate(getDateStatus('ready') || order.shippedAt) }}
                </div>
              </div>

              <!-- Stage 6: Livraison/Retrait -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('delivered')"
                   [class.active]="isStageActive('delivered')">
                <div class="stage-icon">
                  <i class="fas fa-check-double"></i>
                </div>
                <div class="stage-label">
                  {{ order.deliveryInfo.method === 'pickup' ? 'Retiré' : 'Livré' }}
                </div>
                <div class="stage-date" *ngIf="order.deliveredAt">
                  {{ formatDate(order.deliveredAt) }}
                </div>
              </div>

              <!-- Stage 7: Finalisation -->
              <div class="col lifecycle-stage"
                   [class.completed]="isStageCompleted('completed')"
                   [class.active]="isStageActive('completed')">
                <div class="stage-icon">
                  <i class="fas fa-file-invoice"></i>
                </div>
                <div class="stage-label">Facturation</div>
                <div class="stage-date" *ngIf="order.invoice">
                  {{ formatDate(order.invoice?.createdAt) }}
                </div>
                <!-- Documents generated indicators -->
                <div class="documents-indicator mt-1">
                <span class="badge badge-xs me-1"
                      [ngClass]="{'bg-success': order.invoice, 'bg-secondary': !order.invoice}"
                      title="Facture">
                  <i class="fas fa-file-invoice"></i>
                </span>
                  <span class="badge badge-xs"
                        [ngClass]="{'bg-success': order.bonfiscal, 'bg-secondary': !order.bonfiscal}"
                        title="Bon fiscal">
                  <i class="fas fa-receipt"></i>
                </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Current stage details -->
          <div class="current-stage-details mt-3" *ngIf="getCurrentStageDetails()">
            <div class="alert alert-info py-2 px-3">
              <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                <div class="flex-grow-1">
                  <strong>{{ getCurrentStageDetails().title }}</strong>
                  <div class="small">{{ getCurrentStageDetails().description }}</div>
                </div>
                <div class="stage-actions" *ngIf="getCurrentStageDetails().actions?.length > 0">
                  <button *ngFor="let action of getCurrentStageDetails().actions"
                          class="btn btn-sm btn-outline-primary me-1"
                          [disabled]="isSubmitting"
                          (click)="executeStageAction(action.key)">
                    <i class="fas" [ngClass]="action.icon"></i>
                    {{ action.label }}
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action buttons -->
  <div class="action-buttons-bar mb-4">
    <div class="row">
      <div class="col-md-8">
        <div class="btn-group me-2">
          <button class="btn btn-primary"
                  *ngIf="canUpdateStatus()"
                  (click)="openUpdateStatusModal()">
            <i class="fas fa-edit"></i> Modifier statut
          </button>
          <button class="btn btn-outline-info"
                  *ngIf="canAddNote()"
                  (click)="openAddNoteModal()">
            <i class="fas fa-sticky-note"></i> Ajouter note
          </button>
          <button class="btn btn-outline-secondary"
                  *ngIf="permissions.manageTracking"
                  (click)="openTrackingModal()">
            <i class="fas fa-truck"></i> Suivi
          </button>
        </div>

        <div class="btn-group me-2">
          <button class="btn btn-outline-warning"
                  *ngIf="canProcessRefund()"
                  (click)="openRefundModal()">
            <i class="fas fa-undo"></i> Rembourser
          </button>
          <button class="btn btn-outline-info"
                  *ngIf="canProcessReturn()"
                  (click)="openReturnModal()">
            <i class="fas fa-reply"></i> Retour
          </button>
        </div>

        <div class="btn-group">
          <button class="btn btn-outline-danger"
                  *ngIf="canDelete()"
                  (click)="deleteOrder()">
            <i class="fas fa-trash"></i> Supprimer
          </button>
        </div>
      </div>

      <div class="col-md-4 text-end">
        <div class="order-total">
          <h3 class="mb-0">{{ formatCurrency(order.totalAmount) }}</h3>
          <small class="text-muted">
            {{ order.getTotalItems() }} article(s) •
            {{ getPaymentStatusLabel(order.payment.status) }}
          </small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs navigation -->
  <ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              [class.active]="activeTab === 'overview'"
              (click)="setActiveTab('overview')">
        <i class="fas fa-info-circle"></i> Vue d'ensemble
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              [class.active]="activeTab === 'items'"
              (click)="setActiveTab('items')">
        <i class="fas fa-shopping-cart"></i> Articles ({{ order.items.length }})
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              [class.active]="activeTab === 'payment'"
              (click)="setActiveTab('payment')">
        <i class="fas fa-credit-card"></i> Paiement
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link"
              [class.active]="activeTab === 'delivery'"
              (click)="setActiveTab('delivery')">
        <i class="fas fa-truck"></i> Livraison
      </button>
    </li>
    <li class="nav-item" role="presentation" *ngIf="permissions.viewOrder">
      <button class="nav-link"
              [class.active]="activeTab === 'documents'"
              (click)="setActiveTab('documents')">
        <i class="fas fa-file-alt"></i> Documents
        <span class="badge bg-success ms-1" *ngIf="getGeneratedDocumentsCount() > 0">
      {{ getGeneratedDocumentsCount() }}
    </span>
      </button>
    </li>
    <li class="nav-item" role="presentation" *ngIf="permissions.viewHistory">
      <button class="nav-link"
              [class.active]="activeTab === 'history'"
              (click)="setActiveTab('history')">
        <i class="fas fa-history"></i> Historique
        <span class="badge bg-secondary ms-1" *ngIf="orderHistory.length > 0">{{ orderHistory.length }}</span>
      </button>
    </li>
    <li class="nav-item" role="presentation" *ngIf="permissions.viewRelatedOrders && order.customer">
      <button class="nav-link"
              [class.active]="activeTab === 'related'"
              (click)="setActiveTab('related')">
        <i class="fas fa-link"></i> Commandes liées
        <span class="badge bg-secondary ms-1" *ngIf="relatedOrders.length > 0">{{ relatedOrders.length }}</span>
      </button>
    </li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content">
    <!-- Overview tab -->
    <div class="tab-pane" [class.show]="activeTab === 'overview'" [class.active]="activeTab === 'overview'">
      <div class="row">
        <!-- Customer info -->
        <div class="col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center">
              <i class="fas fa-user me-2"></i>
              <h6 class="mb-0">Client</h6>
            </div>
            <div class="card-body">
              <div *ngIf="order.customer" class="customer-details">
                <div class="d-flex align-items-center mb-3">
                  <div class="avatar me-3">
                    <div class="avatar-circle">
                      {{ order.customer.getInitials() }}
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-1">
                      <a href="javascript:void(0)" (click)="goToCustomerDetail()" class="text-decoration-none">
                        {{ order.customer.getFullName() }}
                      </a>
                    </h6>
                    <small class="text-muted">{{ order.customer.email }}</small>
                  </div>
                </div>

                <div class="customer-stats row text-center">
                  <div class="col-4">
                    <div class="stat-item">
                      <div class="stat-value">{{ order.customer.totalOrders }}</div>
                      <div class="stat-label">Commandes</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-item">
                      <div class="stat-value">{{ formatCurrency(order.customer.totalSpent) }}</div>
                      <div class="stat-label">Dépensé</div>
                    </div>
                  </div>
                  <div class="col-4">
                    <div class="stat-item">
                      <span class="badge bg-primary">{{ order.customer.getLoyaltyTierLabel() }}</span>
                      <div class="stat-label">Niveau</div>
                    </div>
                  </div>
                </div>

                <div class="mt-3" *ngIf="order.customer.hasAllergies()">
                  <div class="alert alert-warning py-2 px-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Allergies:</strong> {{ order.customer.medicalInfo.allergies.join(', ') }}
                  </div>
                </div>

                <div class="contact-info mt-3">
                  <div *ngIf="order.customer.defaultPhone" class="mb-2">
                    <i class="fas fa-phone text-muted me-2"></i>
                    {{ order.customer.defaultPhone.digits }}
                  </div>
                  <div *ngIf="order.customer.dateOfBirth" class="mb-2">
                    <i class="fas fa-birthday-cake text-muted me-2"></i>
                    {{ order.customer.getAge() }} ans
                  </div>
                </div>
              </div>
              <div *ngIf="!order.customer" class="text-muted text-center py-3">
                <i class="fas fa-user-slash mb-2"></i>
                <p>Informations client non disponibles</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Order summary -->
        <div class="col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center">
              <i class="fas fa-receipt me-2"></i>
              <h6 class="mb-0">Résumé commande</h6>
            </div>
            <div class="card-body">
              <div class="order-summary">
                <div class="summary-row d-flex justify-content-between mb-2">
                  <span>Sous-total:</span>
                  <span>{{ formatCurrency(order.subtotal) }}</span>
                </div>
                <div class="summary-row d-flex justify-content-between mb-2" *ngIf="order.shippingCost > 0">
                  <span>Livraison:</span>
                  <span>{{ formatCurrency(order.shippingCost) }}</span>
                </div>
                <div class="summary-row d-flex justify-content-between mb-2" *ngIf="order.taxAmount > 0">
                  <span>Taxes:</span>
                  <span>{{ formatCurrency(order.taxAmount) }}</span>
                </div>
                <div class="summary-row d-flex justify-content-between mb-2 text-success" *ngIf="order.discountAmount > 0">
                  <span>Remise:</span>
                  <span>-{{ formatCurrency(order.discountAmount) }}</span>
                </div>
                <div class="summary-row d-flex justify-content-between mb-3 text-success" *ngIf="order.coupon?.appliedDiscount > 0">
                  <span>Coupon ({{ order.coupon?.code }}):</span>
                  <span>-{{ formatCurrency(order.coupon?.appliedDiscount) }}</span>
                </div>
                <hr>
                <div class="summary-row d-flex justify-content-between total-row">
                  <strong>Total:</strong>
                  <strong>{{ formatCurrency(order.totalAmount) }}</strong>
                </div>
              </div>

              <div class="order-meta mt-4">
                <div class="meta-item mb-2">
                  <i class="fas fa-calendar text-muted me-2"></i>
                  <span>Commandé le {{ formatDate(order.orderDate) }}</span>
                </div>
                <div class="meta-item mb-2" *ngIf="order.confirmedAt">
                  <i class="fas fa-check text-muted me-2"></i>
                  <span>Confirmé le {{ formatDate(order.confirmedAt) }}</span>
                </div>
                <div class="meta-item mb-2" *ngIf="order.deliveredAt">
                  <i class="fas fa-truck text-muted me-2"></i>
                  <span>Livré le {{ formatDate(order.deliveredAt) }}</span>
                </div>
                <div class="meta-item mb-2" *ngIf="order.requiresPrescription()">
                  <i class="fas fa-prescription text-warning me-2"></i>
                  <span class="text-warning">Ordonnance requise</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pharmacy info -->
        <div class="col-lg-4 mb-4">
          <div class="card h-100">
            <div class="card-header d-flex align-items-center">
              <i class="fas fa-hospital me-2"></i>
              <h6 class="mb-0">Pharmacie</h6>
            </div>
            <div class="card-body">
              <div *ngIf="order.pharmacy" class="pharmacy-details">
                <h6>
                  <a href="javascript:void(0)" (click)="goToPharmacyDetail()" class="text-decoration-none">
                    {{ order.pharmacy.name }}
                  </a>
                </h6>
                <div class="pharmacy-address text-muted">
                  <i class="fas fa-map-marker-alt me-2"></i>
                  {{ order.pharmacy.address }}<br>
                  {{ order.pharmacy.city }}
                </div>
                <div class="pharmacy-contact mt-3" *ngIf="order.pharmacy.phoneNumber">
                  <i class="fas fa-phone text-muted me-2"></i>
                  {{ order.pharmacy.phoneNumber }}
                </div>
                <div class="pharmacy-contact mt-2" *ngIf="order.pharmacy.email">
                  <i class="fas fa-envelope text-muted me-2"></i>
                  {{ order.pharmacy.email }}
                </div>
              </div>
              <div *ngIf="!order.pharmacy" class="text-muted text-center py-3">
                <i class="fas fa-hospital-slash mb-2"></i>
                <p>Informations pharmacie non disponibles</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notes section -->
      <div class="row" *ngIf="order.clientNotes.length > 0 || order.pharmacyNotes.length > 0 || order.internalNotes.length > 0">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-sticky-note me-2"></i>Notes</h6>
            </div>
            <div class="card-body">
              <div class="notes-container">
                <div *ngIf="order.clientNotes.length > 0" class="note-item mb-3">
                  <div class="note-header d-flex align-items-center mb-2">
                    <i class="fas fa-user text-primary me-2"></i>
                    <strong class="text-primary">Note client</strong>
                  </div>
                  <div class="note-content" *ngFor="let clientNote of order.clientNotes">{{ clientNote.note }}</div>
                </div>

                <div *ngIf="order.pharmacyNotes.length > 0" class="note-item mb-3">
                  <div class="note-header d-flex align-items-center mb-2">
                    <i class="fas fa-hospital text-info me-2"></i>
                    <strong class="text-info">Note pharmacie</strong>
                  </div>
                  <div class="note-content" *ngFor="let pharmacyNote of order.pharmacyNotes">{{ pharmacyNote.note }}</div>
                </div>

                <div *ngIf="order.internalNotes.length > 0" class="note-item mb-3">
                  <div class="note-header d-flex align-items-center mb-2">
                    <i class="fas fa-lock text-secondary me-2"></i>
                    <strong class="text-secondary">Note interne</strong>
                  </div>
                  <div class="note-content"
                       *ngFor="let internalNote of order.internalNotes;">
                    @if(isVisibleInternalNote(internalNote)){
                      {{internalNote.note }}
                        <span *ngIf="internalNote.updatedAt" class = "text-muted" >
                        (a {{internalNote.updatedAt | date: 'dd/MM/yyyy HH:mm' }})
                        </span >
                          <span class="text-muted {{ getClassForInternalNote(internalNote) }}" [ngbTooltip]="getInternalNoteLabel(internalNote)">
                          <i class="fa fa-eye"></i>
                        </span >
                      }
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Items tab -->
    <div class="tab-pane" [class.show]="activeTab === 'items'" [class.active]="activeTab === 'items'">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="mb-0">
            <i class="fas fa-shopping-cart me-2"></i>
            Articles commandés ({{ order.items.length }})
          </h6>
          <div class="items-summary">
            <span class="badge bg-primary">{{ order.getTotalItems() }} articles</span>
            <span class="badge bg-warning ms-2" *ngIf="order.requiresPrescription()">
              <i class="fas fa-prescription me-1"></i>Ordonnance requise
            </span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
              <tr>
                <th>Produit</th>
                <th>Prix unitaire</th>
                <th>Taxes Unitaire</th>
                <th>Quantité</th>
                <th>Total HT</th>
                <th>Total Taxes</th>
                <th>Total TTC</th>
                <th>Ordonnance</th>
                <th>Actions</th>
              </tr>
              </thead>
              <tbody>
              <tr *ngFor="let item of order.items; let i = index">
                <td>
                  <div class="product-info d-flex">
                    <div class="product-image me-3" *ngIf="item.product.getMainImageUrl()">
                      <img [src]="internalPathUrl + (item.product.getMainImageUrl() ?? item.product.images[0]?.url)"
                           [alt]="item.product.name"
                           class="product-thumb"
                           style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                    </div>
                    <div class="product-details">
                      <h6 class="product-name mb-1">{{ item.product.name }}</h6>
                      <small class="product-ref text-muted d-block" *ngIf="item.product.sku">
                        Réf: {{ item.product.sku }}
                      </small>
                      <small class="product-category text-muted" *ngFor="let cat of item.product.categories">
                        {{ cat.name }}
                      </small>
                      <div class="product-badges mt-1">
                        <span class="badge bg-warning badge-sm" *ngIf="item.product.requiresPrescription">
                            <i class="fas fa-prescription"></i>
                          </span>
                      </div>
                    </div>
                  </div>
                </td>
                <td>
                  <span class="price">{{ formatCurrency(item.unitPrice) }}</span>
                  <small class="discount text-success d-block" *ngIf="item.product.originalPrice && item.product.originalPrice > item.unitPrice">
                    <del>{{ formatCurrency(item.product.originalPrice) }}</del>
                  </small>
                </td>
                <td>
                  <p *ngFor="let taxe of item.applicableTaxes">
                    {{ taxe.taxe.name }}: {{ formatCurrency(item.product.calculateProductTax(taxe.taxe, taxe.rateId)) }}
                  </p>
                </td>
                <td>
                  <span class="badge bg-light text-dark">{{ item.quantity }}</span>
                </td>
                <td>
                  <strong>{{ formatCurrency(item.totalPrice) }}</strong>
                </td>
                <td>
                  <strong>{{ formatCurrency(item.taxesPrice) }}</strong>
                </td>
                <td>
                  <strong>{{ formatCurrency(item.taxesPrice + item.totalPrice) }}</strong>
                </td>
                <td>
                  <div *ngIf="item.prescriptionRequired" class="prescription-status">
                      <span class="badge"
                            [ngClass]="{'bg-success': item.prescriptionProvided, 'bg-warning': !item.prescriptionProvided}">
                        <i class="fas" [ngClass]="{'fa-check': item.prescriptionProvided, 'fa-clock': !item.prescriptionProvided}"></i>
                        {{ item.prescriptionProvided ? 'Fournie' : 'En attente' }}
                      </span>
                    <button class="btn btn-link btn-sm p-0 ms-2"
                            *ngIf="item.prescriptionDocument"
                            (click)="viewPrescription(item.prescriptionDocument)">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                  <span *ngIf="!item.prescriptionRequired" class="text-muted">Non requise</span>
                </td>
                <td>
                  <div class="btn-group-sm">
                    <button class="btn btn-outline-primary btn-sm me-1"
                            *ngIf="item.prescriptionRequired && !item.prescriptionProvided"
                            (click)="uploadPrescription(item)">
                      <i class="fas fa-upload"></i>
                    </button>
                    <button class="btn btn-outline-info btn-sm"
                            (click)="viewProductDetails(item.product)">
                      <i class="fas fa-info"></i>
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
              <tfoot class="table-light">
              <tr>
                <th colspan="4">Total</th>
                <th>{{ formatCurrency(getItemsTotalHT()) }}</th>
                <th>{{ formatCurrency(getItemsTotalTaxe()) }}</th>
                <th>{{ formatCurrency(getItemsTotalTTC()) }}</th>
                <th colspan="2"></th>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Payment tab -->
    <div class="tab-pane" [class.show]="activeTab === 'payment'" [class.active]="activeTab === 'payment'">
      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-credit-card me-2"></i>Informations de paiement</h6>
            </div>
            <div class="card-body">
              <div class="payment-details">
                <div class="row mb-3">
                  <div class="col-sm-4">
                    <strong>Méthode de paiement:</strong>
                  </div>
                  <div class="col-sm-8">
                    <span class="badge bg-info">{{ order.getPaymentMethodLabel() }}</span>
                  </div>
                </div>

                <div class="row mb-3">
                  <div class="col-sm-4">
                    <strong>Statut:</strong>
                  </div>
                  <div class="col-sm-8">
                    <span class="badge"
                          [ngClass]="getPaymentStatusBadgeClass(order.payment.status)">
                      {{ getPaymentStatusLabel(order.payment.status) }}
                    </span>
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.payment.transactionId">
                  <div class="col-sm-4">
                    <strong>ID Transaction:</strong>
                  </div>
                  <div class="col-sm-8">
                    <code>{{ order.payment.transactionId }}</code>
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.payment.paidAt">
                  <div class="col-sm-4">
                    <strong>Payé le:</strong>
                  </div>
                  <div class="col-sm-8">
                    {{ formatDate(order.payment.paidAt) }}
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.payment.refundAmount > 0">
                  <div class="col-sm-4">
                    <strong>Montant remboursé:</strong>
                  </div>
                  <div class="col-sm-8">
                    <span class="text-warning">{{ formatCurrency(order.payment.refundAmount) }}</span>
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.payment.refundReason">
                  <div class="col-sm-4">
                    <strong>Raison du remboursement:</strong>
                  </div>
                  <div class="col-sm-8">
                    {{ order.payment.refundReason }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-calculator me-2"></i>Récapitulatif financier</h6>
            </div>
            <div class="card-body">
              <div class="financial-summary">
                <div class="d-flex justify-content-between mb-2">
                  <span>Sous-total:</span>
                  <span>{{ formatCurrency(order.subtotal) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2" *ngIf="order.shippingCost > 0">
                  <span>Livraison:</span>
                  <span>{{ formatCurrency(order.shippingCost) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2" *ngIf="order.taxAmount > 0">
                  <span>Taxes:</span>
                  <span>{{ formatCurrency(order.taxAmount) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2 text-success" *ngIf="order.discountAmount > 0">
                  <span>Remise:</span>
                  <span>-{{ formatCurrency(order.discountAmount) }}</span>
                </div>
                <div class="d-flex justify-content-between mb-3 text-success" *ngIf="order.coupon?.appliedDiscount > 0">
                  <span>Coupon:</span>
                  <span>-{{ formatCurrency(order.coupon?.appliedDiscount) }}</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-2">
                  <strong>Total facturé:</strong>
                  <strong>{{ formatCurrency(order.totalAmount) }}</strong>
                </div>
                <div class="d-flex justify-content-between mb-2 text-success" *ngIf="order.payment.status === 'paid'">
                  <span>Montant payé:</span>
                  <span>{{ formatCurrency(order.totalAmount) }}</span>
                </div>
                <div class="d-flex justify-content-between text-warning" *ngIf="order.payment.refundAmount > 0">
                  <span>Montant remboursé:</span>
                  <span>{{ formatCurrency(order.payment.refundAmount) }}</span>
                </div>
                <hr *ngIf="order.payment.refundAmount > 0">
                <div class="d-flex justify-content-between" *ngIf="order.payment.refundAmount > 0">
                  <strong>Solde net:</strong>
                  <strong>{{ formatCurrency(order.totalAmount - order.payment.refundAmount) }}</strong>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Delivery tab -->
    <div class="tab-pane" [class.show]="activeTab === 'delivery'" [class.active]="activeTab === 'delivery'">
      <div class="row">
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-truck me-2"></i>Informations de livraison</h6>
            </div>
            <div class="card-body">
              <div class="delivery-details">
                <div class="row mb-3">
                  <div class="col-sm-4">
                    <strong>Méthode:</strong>
                  </div>
                  <div class="col-sm-8">
                    <span class="badge bg-primary">{{ order.getDeliveryMethodLabel() }}</span>
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.deliveryInfo?.trackingNumber">
                  <div class="col-sm-4">
                    <strong>Numéro de suivi:</strong>
                  </div>
                  <div class="col-sm-8">
                    <code>{{ order.deliveryInfo.trackingNumber }}</code>
                    <button class="btn btn-link btn-sm p-0 ms-2"
                            *ngIf="order.deliveryInfo?.trackingUrl"
                            (click)="openTrackingModal()">
                      <i class="fas fa-external-link-alt"></i>
                    </button>
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.deliveryInfo?.deliveryProvider">
                  <div class="col-sm-4">
                    <strong>Transporteur:</strong>
                  </div>
                  <div class="col-sm-8">
                    {{ order.deliveryInfo.deliveryProvider }}
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.deliveryInfo?.estimatedDeliveryDate">
                  <div class="col-sm-4">
                    <strong>Livraison prévue:</strong>
                  </div>
                  <div class="col-sm-8">
                    {{ formatDate(order.deliveryInfo.estimatedDeliveryDate) }}
                  </div>
                </div>

                <div class="row mb-3" *ngIf="order.deliveredAt">
                  <div class="col-sm-4">
                    <strong>Livré le:</strong>
                  </div>
                  <div class="col-sm-8">
                    <span class="text-success">
                      <i class="fas fa-check me-1"></i>
                      {{ formatDate(order.deliveredAt) }}
                    </span>
                  </div>
                </div>
              </div>

              <!-- Delivery address -->
              <div class="delivery-address mt-4">
                <h6 class="mb-3">
                  <i class="fas fa-map-marker-alt me-2"></i>
                  Adresse de livraison
                </h6>
                <div class="address-card p-3 border rounded">
                  <div class="recipient-name mb-2">
                    <strong>{{ order.deliveryInfo?.address?.firstName }} {{ order.deliveryInfo?.address?.lastName }}</strong>
                  </div>
                  <div class="address-lines">
                    <div>{{ order.deliveryInfo?.address?.street }}</div>
                    <div>{{ order.deliveryInfo?.address?.postalCode }} {{ order.deliveryInfo?.address?.city }}</div>
                    <div *ngIf="order.deliveryInfo?.address?.country">{{ order.deliveryInfo.address.country.name }}</div>
                  </div>
                  <div class="contact-info mt-2" *ngIf="order.deliveryInfo?.address?.phone">
                    <i class="fas fa-phone text-muted me-2"></i>
                    {{ order.deliveryInfo.address.phone }}
                  </div>
                  <div class="delivery-instructions mt-2" *ngIf="order.deliveryInfo?.address?.instructions">
                    <i class="fas fa-info-circle text-muted me-2"></i>
                    <em>{{ order.deliveryInfo.address.instructions }}</em>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-route me-2"></i>Suivi de livraison</h6>
            </div>
            <div class="card-body">
              <div class="delivery-timeline">
                <div class="timeline-item"
                     [class.completed]="isStatusCompleted('confirmed')">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <h6>Commande confirmée</h6>
                    <small *ngIf="order.confirmedAt">{{ formatDate(order.confirmedAt) }}</small>
                  </div>
                </div>

                <div class="timeline-item"
                     [class.completed]="isStatusCompleted('preparing')">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <h6>En préparation</h6>
                  </div>
                </div>

                <div class="timeline-item"
                     [class.completed]="isStatusCompleted('ready_for_pickup')">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <h6>Prête pour expédition</h6>
                  </div>
                </div>

                <div class="timeline-item"
                     [class.completed]="isStatusCompleted('out_for_delivery')">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <h6>En cours de livraison</h6>
                    <small *ngIf="order.shippedAt">{{ formatDate(order.shippedAt) }}</small>
                  </div>
                </div>

                <div class="timeline-item"
                     [class.completed]="isStatusCompleted('delivered')">
                  <div class="timeline-marker"></div>
                  <div class="timeline-content">
                    <h6>Livrée</h6>
                    <small *ngIf="order.deliveredAt">{{ formatDate(order.deliveredAt) }}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Tab Content -->
    <div class="tab-pane" [class.show]="activeTab === 'documents'" [class.active]="activeTab === 'documents'" *ngIf="permissions.viewOrder">
      <div class="row">
        <!-- Generated Documents -->
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h6 class="mb-0">
                <i class="fas fa-file-alt me-2"></i>
                Documents générés
              </h6>
              <div class="documents-actions">
                <button class="btn btn-sm btn-outline-primary me-2"
                        *ngIf="canGenerateInvoice()"
                        [disabled]="isSubmitting"
                        (click)="generateInvoice()">
                  <i class="fas fa-file-invoice me-1"></i>
                  Générer facture
                </button>
                <button class="btn btn-sm btn-outline-success"
                        *ngIf="canGenerateFiscalReceipt()"
                        [disabled]="isSubmitting"
                        (click)="generateFiscalReceipt()">
                  <i class="fas fa-receipt me-1"></i>
                  Générer bon fiscal
                </button>
              </div>
            </div>
            <div class="card-body">
              <!-- Documents list -->
              <div class="documents-list">
                <!-- Invoice -->
                <div class="document-item d-flex align-items-center justify-content-between p-3 border rounded mb-3"
                     [class.border-success]="order.invoice">
                  <div class="d-flex align-items-center">
                    <div class="document-icon me-3">
                      <i class="fas fa-file-invoice fa-2x"
                         [class.text-success]="order.invoice"
                         [class.text-muted]="!order.invoice"></i>
                    </div>
                    <div class="document-details">
                      <h6 class="mb-1">Facture</h6>
                      <div class="document-status">
                    <span class="badge" [ngClass]="order.invoice ? 'bg-success' : 'bg-secondary'">
                      {{ order.invoice ? 'Générée' : 'Non générée' }}
                    </span>
                        <small class="text-muted ms-2" *ngIf="order.invoice">
                          le {{ formatDate(order.invoice?.createdAt) }}
                        </small>
                      </div>
                      <div class="document-info mt-1" *ngIf="order.invoice?.invoiceNumber">
                        <small class="text-muted">N° {{ order.invoice?.invoiceNumber }}</small>
                      </div>
                    </div>
                  </div>
                  <div class="document-actions">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-primary"
                              *ngIf="order.invoice"
                              (click)="viewDocument('invoice')">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-secondary"
                              *ngIf="order.invoice"
                              (click)="viewDocument('invoice','pdfData', false)">
                        <i class="fas fa-download"></i>
                      </button>
                      <button class="btn btn-sm btn-primary"
                              *ngIf="!order.invoice && canGenerateInvoice()"
                              [disabled]="isSubmitting"
                              (click)="generateInvoice()">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Fiscal Receipt -->
                <div class="document-item d-flex align-items-center justify-content-between p-3 border rounded mb-3"
                     [class.border-success]="order.bonfiscal">
                  <div class="d-flex align-items-center">
                    <div class="document-icon me-3">
                      <i class="fas fa-receipt fa-2x"
                         [class.text-success]="order.bonfiscal"
                         [class.text-muted]="!order.bonfiscal"></i>
                    </div>
                    <div class="document-details">
                      <h6 class="mb-1">Bon fiscal</h6>
                      <div class="document-status">
                    <span class="badge" [ngClass]="order.bonfiscal ? 'bg-success' : 'bg-secondary'">
                      {{ order.bonfiscal ? 'Généré' : 'Non généré' }}
                    </span>
                        <small class="text-muted ms-2" *ngIf="order.bonfiscal">
                          le {{ formatDate(order.bonfiscal.createdAt) }}
                        </small>
                      </div>
                      <div class="document-info mt-1" *ngIf="order.bonfiscal">
                        <small class="text-muted">N° {{ order.bonfiscal?.bonfiscalNumber }}</small>
                      </div>
                    </div>
                  </div>
                  <div class="document-actions">
                    <div class="btn-group">
                      <button class="btn btn-sm btn-outline-primary"
                              *ngIf="order.bonfiscal"
                              (click)="viewDocument('fiscal_receipt')">
                        <i class="fas fa-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-secondary"
                              *ngIf="order.bonfiscal"
                              (click)="viewDocument('fiscal_receipt','pdfData', false)">

                        <i class="fas fa-download"></i>
                      </button>
                      <button class="btn btn-sm btn-success"
                              *ngIf="!order.bonfiscal && canGenerateFiscalReceipt()"
                              [disabled]="isSubmitting"
                              (click)="generateFiscalReceipt()">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Delivery Note -->
<!--                <div class="document-item d-flex align-items-center justify-content-between p-3 border rounded mb-3"-->
<!--                     *ngIf="order.deliveryInfo.method !== 'pickup'"-->
<!--                     [class.border-success]="order.invoice?.generations.length > 0">-->
<!--                  <div class="d-flex align-items-center">-->
<!--                    <div class="document-icon me-3">-->
<!--                      <i class="fas fa-clipboard-list fa-2x"-->
<!--                         [class.text-success]="order.invoice?.generations.length > 0"-->
<!--                         [class.text-muted]="order.invoice?.generations.length == 0"></i>-->
<!--                    </div>-->
<!--                    <div class="document-details">-->
<!--                      <h6 class="mb-1">Bon de livraison</h6>-->
<!--                      <div class="document-status">-->
<!--                    <span class="badge" [ngClass]="order.invoice?.generations.length > 0 ? 'bg-success' : 'bg-secondary'">-->
<!--                      {{ order.invoice?.generations.length > 0 ? 'Généré' : 'Non généré' }}-->
<!--                    </span>-->
<!--                        <small class="text-muted ms-2" *ngIf="order.deliveryNoteGeneratedAt">-->
<!--                          le {{ formatDate(order.deliveryNoteGeneratedAt) }}-->
<!--                        </small>-->
<!--                      </div>-->
<!--                    </div>-->
<!--                  </div>-->
<!--                  <div class="document-actions">-->
<!--                    <div class="btn-group">-->
<!--                      <button class="btn btn-sm btn-outline-primary"-->
<!--                              *ngIf="order.deliveryNoteGenerated"-->
<!--                              (click)="viewDocument('delivery_note')">-->
<!--                        <i class="fas fa-eye"></i>-->
<!--                      </button>-->
<!--                      <button class="btn btn-sm btn-outline-secondary"-->
<!--                              *ngIf="order.deliveryNoteGenerated"-->
<!--                              (click)="downloadDocument('delivery_note')">-->
<!--                        <i class="fas fa-download"></i>-->
<!--                      </button>-->
<!--                      <button class="btn btn-sm btn-outline-info"-->
<!--                              *ngIf="!order.deliveryNoteGenerated && canGenerateDeliveryNote()"-->
<!--                              [disabled]="isSubmitting"-->
<!--                              (click)="generateDeliveryNote()">-->
<!--                        <i class="fas fa-plus"></i>-->
<!--                      </button>-->
<!--                    </div>-->
<!--                  </div>-->
<!--                </div>-->
              </div>

              <!-- Document generation info -->
              <div class="alert alert-info mt-3" *ngIf="!hasAllRequiredDocuments()">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Information:</strong>
                Les documents sont générés automatiquement selon l'état de la commande.
                La facture est générée après livraison, le bon fiscal après règlement complet.
              </div>
            </div>
          </div>
        </div>

        <!-- Document Templates & Settings -->
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header">
              <h6><i class="fas fa-cog me-2"></i>Configuration documents</h6>
            </div>
            <div class="card-body">
<!--              generatePrintContent damien -->
              <div class="document-settings">
                <div class="mb-3">
                  <label class="form-label">Modèle de facture</label>
                  <select class="form-select form-select-sm" [(ngModel)]="documentSettings.invoiceTemplate">
                    <option value="standard">Standard</option>
                    <option value="detailed">Détaillé</option>
                  </select>
                </div>

                <div class="mb-3">
                  <label class="form-label">Format d'export</label>
                  <select class="form-select form-select-sm" [(ngModel)]="documentSettings.exportFormat">
                    <option value="A4">A4</option>
<!--                    <option value="pdf_a3">PDF/A-3</option>-->
                  </select>
                </div>
              </div>

              <!-- Quick actions -->
              <div class="document-quick-actions mt-4">
                <h6 class="mb-3">Actions rapides</h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary btn-sm"
                          [disabled]="!canRegenerateDocuments()"
                          (click)="regenerateAllDocuments()">
                    <i class="fas fa-sync me-2"></i>
                    Régénérer les documents possibles
                  </button>
                  <button class="btn btn-outline-success btn-sm"
                          [disabled]="!hasGeneratedDocuments()"
                          (click)="emailAllDocuments()">
                    <i class="fas fa-envelope me-2"></i>
                    <i class="fas fa-circle-user me-2"></i>
                    Envoyer par email au client
                  </button>
                  <button class="btn btn-outline-success btn-sm"
                          [disabled]="!hasGeneratedDocuments()"
                          (click)="emailAllDocuments(true)">
                    <i class="fas fa-envelope me-2"></i>
                    <i class="fas fa-user-alt me-2"></i>
                    M'envoyer par email
                  </button>
                  <button class="btn btn-outline-info btn-sm"
                          [disabled]="!hasGeneratedDocuments()"
                          (click)="downloadAllDocuments()">
                    <i class="fas fa-download me-2"></i>
                    Télécharger tout (ZIP)
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- History tab -->
    <div class="tab-pane" [class.show]="activeTab === 'history'" [class.active]="activeTab === 'history'" *ngIf="permissions.viewHistory">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="mb-0">
            <i class="fas fa-history me-2"></i>
            Historique des modifications
          </h6>
          <button class="btn btn-sm btn-outline-secondary" (click)="loadOrderHistory()">
            <i class="fas fa-sync-alt"></i> Actualiser
          </button>
        </div>
        <div class="card-body">
          <!-- Loading state -->
          <div *ngIf="isLoadingHistory" class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>

          <!-- History timeline -->
          <div *ngIf="!isLoadingHistory && orderHistory.length > 0" class="history-timeline">
            <div *ngFor="let entry of orderHistory" class="timeline-entry mb-3">
              <div class="d-flex">
                <div class="timeline-content flex-grow-1">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h6 class="mb-1">{{ entry.title }}</h6>
                      <p class="mb-1" *ngIf="entry.description">{{ entry.description }}</p>
                      <small class="text-muted">
                        {{ formatDate(entry.timestamp) }}
                        <span *ngIf="entry.user"> • {{ entry.user }}</span>
                      </small>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Empty state -->
          <div *ngIf="!isLoadingHistory && orderHistory.length === 0" class="text-center py-4">
            <i class="fas fa-history fa-2x text-muted mb-2"></i>
            <p class="text-muted">Aucun historique disponible</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Related orders tab -->
    <div class="tab-pane" [class.show]="activeTab === 'related'" [class.active]="activeTab === 'related'" *ngIf="permissions.viewRelatedOrders">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h6 class="mb-0">
            <i class="fas fa-link me-2"></i>
            Autres commandes du client
          </h6>
          <button class="btn btn-sm btn-outline-secondary" (click)="loadRelatedOrders()">
            <i class="fas fa-sync-alt"></i> Actualiser
          </button>
        </div>
        <div class="card-body">
          <!-- Loading state -->
          <div *ngIf="isLoadingRelated" class="text-center py-3">
            <div class="spinner-border spinner-border-sm" role="status">
              <span class="visually-hidden">Chargement...</span>
            </div>
          </div>

          <!-- Related orders list -->
          <div *ngIf="!isLoadingRelated && relatedOrders.length > 0">
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                <tr>
                  <th>Numéro</th>
                  <th>Date</th>
                  <th>Statut</th>
                  <th>Montant</th>
                  <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let relatedOrder of relatedOrders">
                  <td>
                    <a href="javascript:void(0)"
                       (click)="goToRelatedOrder(relatedOrder._id!)"
                       class="text-decoration-none">
                      {{ relatedOrder.orderNumber }}
                    </a>
                  </td>
                  <td>{{ formatDate(relatedOrder.orderDate) }}</td>
                  <td>
                      <span class="badge" [ngClass]="relatedOrder.getStatusBadgeClass()">
                        {{ relatedOrder.getStatusLabel() }}
                      </span>
                  </td>
                  <td>{{ formatCurrency(relatedOrder.totalAmount) }}</td>
                  <td>
                    <button class="btn btn-outline-primary btn-sm"
                            (click)="goToRelatedOrder(relatedOrder._id!)">
                      <i class="fas fa-eye"></i>
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Empty state -->
          <div *ngIf="!isLoadingRelated && relatedOrders.length === 0" class="text-center py-4">
            <i class="fas fa-link fa-2x text-muted mb-2"></i>
            <p class="text-muted">Aucune autre commande trouvée pour ce client</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->

<!-- Update Status Modal -->
<ng-template #updateStatusModal>
  <div class="modal-header">
    <h4 class="modal-title">Modifier le statut de la commande</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="updateStatusForm">
      <div class="mb-3">
        <label for="status" class="form-label">Nouveau statut *</label>
        <select id="status" class="form-select" formControlName="status">
          <option value="pending">En attente</option>
          <option value="confirmed">Confirmée</option>
          <option value="prescription_pending">Ordonnance en attente</option>
          <option value="preparing">En préparation</option>
          <option value="ready_for_pickup">Prête pour retrait</option>
          <option value="out_for_delivery">En livraison</option>
          <option value="delivered">Livrée</option>
          <option value="completed">Terminée</option>
          <option value="cancelled">Annulée</option>
          <option value="returned">Retournée</option>
          <option value="refunded">Remboursée</option>
        </select>
      </div>

      <div class="mb-3" *ngIf="['out_for_delivery', 'delivered'].includes(updateStatusForm.value.status)">
        <label for="trackingNumber" class="form-label">Numéro de suivi</label>
        <input type="text" id="trackingNumber" class="form-control" formControlName="trackingNumber">
      </div>

      <div class="mb-3" *ngIf="updateStatusForm.value.status === 'out_for_delivery'">
        <label for="estimatedDeliveryDate" class="form-label">Date de livraison estimée</label>
        <input type="datetime-local" id="estimatedDeliveryDate" class="form-control" formControlName="estimatedDeliveryDate">
      </div>

      <div class="mb-3">
        <label for="note" class="form-label">Note (optionnel)</label>
        <textarea id="note" class="form-control" rows="3" formControlName="note" placeholder="Ajouter une note sur ce changement de statut..."></textarea>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="notifyCustomer" formControlName="notifyCustomer">
        <label class="form-check-label" for="notifyCustomer">
          Notifier le client par email
        </label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-primary"
            [disabled]="updateStatusForm.invalid || isSubmitting"
            (click)="updateOrderStatus()">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      Modifier le statut
    </button>
  </div>
</ng-template>

<!-- Add Note Modal -->
<ng-template #addNoteModal>
  <div class="modal-header">
    <h4 class="modal-title">Ajouter une note</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="addNoteForm">
      <div class="mb-3">
        <label for="noteType" class="form-label">Type de note *</label>
        <select id="noteType" class="form-select" formControlName="type">
          <option value="internal">Note interne</option>
          <option value="pharmacy">Note pharmacie</option>
          <option value="customer">Note client</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="noteContent" class="form-label">Contenu de la note *</label>
        <textarea id="noteContent" class="form-control" rows="4" formControlName="note" placeholder="Saisir la note..."></textarea>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="isPrivate" formControlName="isPrivate">
        <label class="form-check-label" for="isPrivate">
          Note privée (visible uniquement en interne)
        </label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-primary"
            [disabled]="addNoteForm.invalid || isSubmitting"
            (click)="addNote()">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      Ajouter la note
    </button>
  </div>
</ng-template>

<!-- Refund Modal -->
<ng-template #refundModal>
  <div class="modal-header">
    <h4 class="modal-title">Traiter un remboursement</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="refundForm">
      <div class="alert alert-info">
        <strong>Montant total de la commande:</strong> {{ formatCurrency(order?.totalAmount || 0) }}
      </div>

      <div class="mb-3">
        <label for="refundAmount" class="form-label">Montant à rembourser *</label>
        <div class="input-group">
          <input type="number" id="refundAmount" class="form-control"
                 formControlName="amount" step="0.01" min="0" [max]="order?.totalAmount || 0">
          <span class="input-group-text">€</span>
        </div>
      </div>

      <div class="mb-3">
        <label for="refundReason" class="form-label">Raison du remboursement *</label>
        <textarea id="refundReason" class="form-control" rows="3" formControlName="reason" placeholder="Expliquer la raison du remboursement..."></textarea>
      </div>

      <div class="mb-3">
        <label for="refundMethod" class="form-label">Méthode de remboursement *</label>
        <select id="refundMethod" class="form-select" formControlName="refundMethod">
          <option value="original">Moyen de paiement original</option>
          <option value="manual">Remboursement manuel</option>
        </select>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="notifyCustomerRefund" formControlName="notifyCustomer">
        <label class="form-check-label" for="notifyCustomerRefund">
          Notifier le client par email
        </label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-warning"
            [disabled]="refundForm.invalid || isSubmitting"
            (click)="processRefund()">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      Traiter le remboursement
    </button>
  </div>
</ng-template>

<!-- Return Modal -->
<ng-template #returnModal>
  <div class="modal-header">
    <h4 class="modal-title">Traiter un retour</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="returnForm">
      <div class="mb-3">
        <label for="returnReason" class="form-label">Raison du retour *</label>
        <textarea id="returnReason" class="form-control" rows="3" formControlName="reason" placeholder="Expliquer la raison du retour..."></textarea>
      </div>

      <div class="mb-3">
        <label for="condition" class="form-label">État du produit *</label>
        <select id="condition" class="form-select" formControlName="condition">
          <option value="damaged">Endommagé</option>
          <option value="expired">Périmé</option>
          <option value="wrong_item">Mauvais article</option>
          <option value="changed_mind">Changement d'avis</option>
          <option value="defective">Défectueux</option>
        </select>
      </div>

      <div class="mb-3">
        <label for="returnRefundAmount" class="form-label">Montant du remboursement</label>
        <div class="input-group">
          <input type="number" id="returnRefundAmount" class="form-control"
                 formControlName="refundAmount" step="0.01" min="0" [max]="order?.totalAmount || 0">
          <span class="input-group-text">€</span>
        </div>
      </div>

      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="restockable" formControlName="restockable">
        <label class="form-check-label" for="restockable">
          Produit remettable en stock
        </label>
      </div>

      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="notifyCustomerReturn" formControlName="notifyCustomer">
        <label class="form-check-label" for="notifyCustomerReturn">
          Notifier le client par email
        </label>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-info"
            [disabled]="returnForm.invalid || isSubmitting"
            (click)="processReturn()">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      Traiter le retour
    </button>
  </div>
</ng-template>

<!-- Tracking Modal -->
<ng-template #trackingModal>
  <div class="modal-header">
    <h4 class="modal-title">Mettre à jour le suivi</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="trackingForm">
      <div class="mb-3">
        <label for="trackingNumberInput" class="form-label">Numéro de suivi *</label>
        <input type="text" id="trackingNumberInput" class="form-control" formControlName="trackingNumber" placeholder="Saisir le numéro de suivi...">
      </div>

      <div class="mb-3">
        <label for="carrier" class="form-label">Transporteur</label>
        <input type="text" id="carrier" class="form-control" formControlName="carrier" placeholder="Nom du transporteur...">
      </div>

      <div class="mb-3">
        <label for="estimatedDelivery" class="form-label">Date de livraison estimée</label>
        <input type="datetime-local" id="estimatedDelivery" class="form-control" formControlName="estimatedDelivery">
      </div>

      <div class="mb-3">
        <label for="trackingUrlInput" class="form-label">URL de suivi</label>
        <input type="url" id="trackingUrlInput" class="form-control" formControlName="trackingUrl" placeholder="https://...">
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-primary"
            [disabled]="trackingForm.invalid || isSubmitting"
            (click)="updateTracking()">
      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>
      Mettre à jour
    </button>
  </div>
</ng-template>

<!-- Prescription Modal -->
<ng-template #prescriptionModal>
  <div class="modal-header">
    <h4 class="modal-title">{{ prescriptionModalData?.prescriptionNumber || 'Ordonnance' }}</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <div *ngIf="permissions.editOrder" class="prescription-viewer">
      <div *ngIf="prescriptionModalData?.document" class="text-center">
        <img [src]="prescriptionModalData.document" class="img-fluid" style="max-height: 500px;">
      </div>
      <div *ngIf="!prescriptionModalData?.document" class="text-center text-muted py-4">
        <i class="fas fa-file-medical fa-3x mb-3"></i>
        <p>Aucune ordonnance disponible</p>
      </div>
    </div>

<!--    *ngIf="prescriptionModalData?.type === 'upload'"-->
<!--    <div class="prescription-uploader"> -->
<!--      <div class="mb-3">-->
<!--        <label for="prescriptionFile" class="form-label">Télécharger l'ordonnance</label>-->
<!--        <input type="file" id="prescriptionFile" class="form-control"-->
<!--               accept="image/*,.pdf" (change)="onPrescriptionFileSelected($event)">-->
<!--        <div class="form-text">Formats acceptés: JPG, PNG, PDF (max 5MB)</div>-->
<!--      </div>-->

<!--      <div *ngIf="selectedPrescriptionFile" class="alert alert-info">-->
<!--        <strong>Fichier sélectionné:</strong> {{ selectedPrescriptionFile.name }}-->
<!--        ({{ (selectedPrescriptionFile.size / 1024 / 1024).toFixed(2) }} MB)-->
<!--      </div>-->
<!--    </div>-->
  </div>
<!--  <div class="modal-footer">-->
<!--    <button type="button" class="btn btn-secondary" (click)="closeModal()">Fermer</button>-->
<!--    <button *ngIf="prescriptionModalData?.type === 'upload'"-->
<!--            type="button" class="btn btn-primary"-->
<!--            [disabled]="!selectedPrescriptionFile || isSubmitting"-->
<!--            (click)="uploadPrescriptionFile()">-->
<!--      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>-->
<!--      Télécharger-->
<!--    </button>-->
<!--  </div>-->
</ng-template>

<!-- Modals manquants à ajouter à la fin du HTML existant -->

<!-- Product Details Modal -->
<ng-template #productDetailModal>
  <div class="modal-header">
    <div class="d-flex align-items-center">
      <img *ngIf="selectedProduct?.getMainImageUrl()"
           [src]="internalPathUrl + selectedProduct.getMainImageUrl()"
           alt="Image produit"
           class="modal-product-image me-3">
      <div *ngIf="!selectedProduct?.getMainImageUrl()" class="modal-no-image me-3">
        <i class="fas fa-image"></i>
      </div>
      <div>
        <h4 class="modal-title mb-1">{{ selectedProduct?.name }}</h4>
        <div class="product-badges">
          <span class="badge" [ngClass]="'bg-' + (selectedProduct?.status === 'active' ? 'success' : 'secondary')">
            {{ selectedProduct.getStatusLabel() }}
          </span>
          <span class="badge bg-primary" *ngIf="selectedProduct?.isFeatured">En vedette</span>
          <span class="badge bg-warning" *ngIf="selectedProduct?.isOnSale">En promotion</span>
          <span class="badge bg-danger" *ngIf="selectedProduct?.requiresPrescription">Ordonnance requise</span>
        </div>
      </div>
    </div>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>

  <div class="modal-body" *ngIf="selectedProduct">
    <!-- Quick Info Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="info-card">
          <div class="info-icon bg-primary">
            <i class="fas fa-barcode"></i>
          </div>
          <div class="info-content">
            <small class="text-muted">SKU</small>
            <strong>{{ selectedProduct.sku }}</strong>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="info-card">
          <div class="info-icon bg-success">
            <i class="fas fa-euro-sign"></i>
          </div>
          <div class="info-content">
            <small class="text-muted">Prix HT</small>
            <strong>{{ formatCurrency(selectedProduct.price) }}</strong>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="info-card">
          <div class="info-icon bg-info">
            <i class="fas fa-receipt"></i>
          </div>
          <div class="info-content">
            <small class="text-muted">Taxes</small>
            <strong>{{ formatCurrency(selectedProduct.calculateProductTax()) }}</strong>
          </div>
        </div>
      </div>

      <div class="col-md-3 col-sm-6">
        <div class="info-card">
          <div class="info-icon bg-warning">
            <i class="fas fa-tag"></i>
          </div>
          <div class="info-content">
            <small class="text-muted">Prix TTC</small>
            <strong>{{ formatCurrency(selectedProduct.calculateProductPriceWithTax()) }}</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [class.active]="productModalTab === 'general'"
                (click)="productModalTab = 'general'"
                type="button">
          <i class="fas fa-info-circle me-2"></i>
          Général
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [class.active]="productModalTab === 'pricing'"
                (click)="productModalTab = 'pricing'"
                type="button">
          <i class="fas fa-euro-sign me-2"></i>
          Prix & Taxes
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [class.active]="productModalTab === 'medical'"
                (click)="productModalTab = 'medical'"
                type="button">
          <i class="fas fa-prescription-bottle me-2"></i>
          Médical
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link"
                [class.active]="productModalTab === 'images'"
                (click)="productModalTab = 'images'"
                type="button">
          <i class="fas fa-images me-2"></i>
          Images
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- General Tab -->
      <div *ngIf="productModalTab === 'general'" class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-6">
            <div class="info-group">
              <label><i class="fas fa-tag me-2 text-primary"></i>Nom</label>
              <p class="fw-bold">{{ selectedProduct.name }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.slug">
              <label><i class="fas fa-link me-2 text-primary"></i>Slug</label>
              <p><code>{{ selectedProduct.slug }}</code></p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.description">
              <label><i class="fas fa-align-left me-2 text-primary"></i>Description</label>
              <p class="text-muted">{{ selectedProduct.description }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.shortDescription">
              <label><i class="fas fa-file-alt me-2 text-primary"></i>Description courte</label>
              <p class="text-muted">{{ selectedProduct.shortDescription }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.categories?.length">
              <label><i class="fas fa-folder me-2 text-primary"></i>Catégories</label>
              <div class="d-flex flex-wrap gap-2">
                <span *ngFor="let category of selectedProduct.categories" class="badge bg-secondary">
                  {{ category.name }}
                </span>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="info-group">
              <label><i class="fas fa-barcode me-2 text-info"></i>SKU</label>
              <p><code class="fs-6">{{ selectedProduct.sku }}</code></p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.barcode">
              <label><i class="fas fa-qrcode me-2 text-info"></i>Code-barres</label>
              <p><code>{{ selectedProduct.barcode }}</code></p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.cipCode">
              <label><i class="fas fa-prescription me-2 text-info"></i>Code CIP</label>
              <p><code>{{ selectedProduct.cipCode }}</code></p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.laboratoire">
              <label><i class="fas fa-flask me-2 text-info"></i>Laboratoire</label>
              <p>{{ selectedProduct.laboratoire }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.marque">
              <label><i class="fas fa-copyright me-2 text-info"></i>Marque</label>
              <p>{{ selectedProduct.marque }}</p>
            </div>

            <div class="info-group">
              <label><i class="fas fa-toggle-on me-2 text-success"></i>Statut & Visibilité</label>
              <div class="d-flex gap-2 flex-wrap">
                <span class="badge" [ngClass]="'bg-' + (selectedProduct.status === 'active' ? 'success' : 'secondary')">
                  <i class="fas" [ngClass]="selectedProduct.status === 'active' ? 'fa-check-circle' : 'fa-times-circle'"></i>
                  {{ selectedProduct.getStatusLabel() }}
                </span>
                <span class="badge" [ngClass]="selectedProduct.isVisible ? 'bg-success' : 'bg-secondary'">
                  <i class="fas" [ngClass]="selectedProduct.isVisible ? 'fa-eye' : 'fa-eye-slash'"></i>
                  {{ selectedProduct.isVisible ? 'Visible' : 'Masqué' }}
                </span>
                <span class="badge bg-warning" *ngIf="selectedProduct.isFeatured">
                  <i class="fas fa-star"></i> En vedette
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing Tab -->
      <div *ngIf="productModalTab === 'pricing'" class="tab-pane fade show active">
        <!-- Tax Impact Summary -->
        <div class="alert alert-info mb-4">
          <small class="text-muted d-block">Augmentation du prix en comparaison des taxes</small>
          <div class="col-md-4">
            <strong class="text-success">
              {{ ((selectedProduct.calculateProductTax() / selectedProduct.price) * 100).toFixed(2) }}%
            </strong>
          </div>
        </div>

        <!-- Pricing Details -->
        <div class="row g-3">
          <!-- Default Pricing -->
          <div class="col-md-6">
            <div class="card border-primary">
              <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                  <i class="fas fa-tags me-2"></i>
                  Prix par défaut
                </h6>
              </div>
              <div class="card-body">
                <div class="pricing-detail">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="text-muted">Prix de vente (HT)</span>
                    <strong class="text-primary fs-5">{{ formatCurrency(selectedProduct.price) }}</strong>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="selectedProduct.originalPrice">
                    <span class="text-muted">Prix original</span>
                    <span class="text-muted text-decoration-line-through">
                      {{ formatCurrency(selectedProduct.originalPrice) }}
                    </span>
                  </div>

                  <div class="d-flex justify-content-between align-items-center mb-2" *ngIf="selectedProduct.cost">
                    <span class="text-muted">Coût d'achat</span>
                    <span>{{ formatCurrency(selectedProduct.cost) }}</span>
                  </div>

                  <hr>

                  <div class="d-flex justify-content-between align-items-center mb-2" *ngFor="let taxe of selectedProduct.taxes">
                    <small class="text-muted d-block">
                      <span class="badge bg-info">{{ taxe.name }}</span>
                    </small>
                    <strong class="text-info">{{ formatCurrency(selectedProduct.calculateProductTax(taxe)) }}</strong>
                  </div>

                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold">Prix de vente (TTC)</span>
                    <strong class="text-success fs-4">
                      {{ formatCurrency(selectedProduct.calculateProductPriceWithTax()) }}
                    </strong>
                  </div>

                  <!-- Profit Margin -->
                  <div class="mt-3 p-2 bg-light rounded" *ngIf="selectedProduct.cost">
                    <small class="text-muted d-block">Marge bénéficiaire</small>
                    <strong class="text-success">
                      {{ selectedProduct.calculateProfitMargin() }}%
                    </strong>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Price Breakdown Chart -->
          <div class="col-md-6">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="fas fa-chart-pie me-2"></i>
                  Répartition du prix
                </h6>
              </div>
              <div class="card-body">
                <div class="price-breakdown">
                  <!-- Visual Bar -->
                  <div class="breakdown-bar mb-3">
                    <div class="bar-segment bg-primary"
                         [style.width.%]="(selectedProduct.price / selectedProduct.calculateProductPriceWithTax()) * 100"
                         [title]="'Prix HT: ' + formatCurrency(selectedProduct.price)">
                    </div>
                    <div class="bar-segment bg-warning"
                         [style.width.%]="(selectedProduct.calculateProductTax() / selectedProduct.calculateProductPriceWithTax()) * 100"
                         [title]="'Taxe: ' + formatCurrency(selectedProduct.calculateProductTax())">
                    </div>
                  </div>

                  <!-- Legend -->
                  <div class="breakdown-legend">
                    <div class="legend-item">
                      <span class="legend-dot bg-primary"></span>
                      <div class="flex-grow-1">
                        <small class="text-muted d-block">Prix HT</small>
                        <strong>{{ formatCurrency(selectedProduct.price) }}</strong>
                        <small class="text-muted">
                          ({{ ((selectedProduct.price / selectedProduct.calculateProductPriceWithTax()) * 100).toFixed(1) }}%)
                        </small>
                      </div>
                    </div>

                    <div class="legend-item">
                      <span class="legend-dot bg-warning"></span>
                      <div class="flex-grow-1" *ngFor="let taxe of selectedProduct.taxes">
                        <small class="text-muted d-block">
                          <span class="badge bg-info" >{{ taxe.name }}</span>
                        </small>
                        <strong>{{ formatCurrency(selectedProduct.calculateProductTax(taxe)) }}</strong>
                        <small class="text-muted">
                          {{ ((selectedProduct.calculateProductTax(taxe) / selectedProduct.calculateProductPriceWithTax()) * 100).toFixed(2) }}%
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- Discount Badge -->
                  <div class="discount-info mt-3" *ngIf="selectedProduct.originalPrice && selectedProduct.originalPrice > selectedProduct.price">
                    <div class="alert alert-warning mb-0">
                      <i class="fas fa-percentage me-2"></i>
                      <strong>Réduction:</strong>
                      {{ ((selectedProduct.originalPrice - selectedProduct.price) / selectedProduct.originalPrice * 100).toFixed(0) }}%
                      ({{ formatCurrency(selectedProduct.originalPrice - selectedProduct.price) }} d'économie)
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Pharmacy Specific Pricing -->
        <div class="mt-4" *ngIf="selectedProduct.pharmacies?.length">
          <h6 class="mb-3">
            <i class="fas fa-store me-2"></i>
            Prix par pharmacie
          </h6>
          <div class="row g-3">
            <div class="col-md-6" *ngFor="let pharmacyData of selectedProduct.pharmacies">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0">{{ pharmacyData.pharmacy.name }}</h6>
                </div>
                <div class="card-body">
                  <div class="d-flex justify-content-between mb-2" *ngIf="pharmacyData.price">
                    <span class="text-muted">Prix HT</span>
                    <strong>{{ formatCurrency(pharmacyData.price) }}</strong>
                  </div>
                  <div class="d-flex justify-content-between mb-2" *ngIf="pharmacyData.price">
                    <div *ngFor="let taxe of selectedProduct.taxes">
                      <span class="text-muted">Taxes {{ taxe.name }}</span>
                      <strong class="text-info">{{ formatCurrency(taxe.calculatePharmacyTax(pharmacyData.price)) }}</strong>
                    </div>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span class="fw-bold">Prix TTC</span>
                    <strong class="text-success">
                      {{ pharmacyData.price ? formatCurrency(pharmacyData.price + selectedProduct.calculateProductPriceWithTax()) : 'Prix par défaut' }}
                    </strong>
                  </div>
                  <div class="mt-2">
                    <span class="badge" [ngClass]="pharmacyData.isAvailable ? 'bg-success' : 'bg-danger'">
                      {{ pharmacyData.isAvailable ? 'Disponible' : 'Indisponible' }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Medical Tab -->
      <div *ngIf="productModalTab === 'medical'" class="tab-pane fade show active">
        <div class="row">
          <div class="col-md-6">
            <div class="info-group">
              <label><i class="fas fa-prescription-bottle me-2 text-danger"></i>Ordonnance</label>
              <p>
                <span class="badge" [ngClass]="selectedProduct.requiresPrescription ? 'bg-danger' : 'bg-success'">
                  <i class="fas" [ngClass]="selectedProduct.requiresPrescription ? 'fa-prescription-bottle' : 'fa-shopping-cart'"></i>
                  {{ selectedProduct.requiresPrescription ? 'Requise' : 'Non requise' }}
                </span>
              </p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.requiresPrescription && selectedProduct.prescriptionType">
              <label><i class="fas fa-file-prescription me-2 text-warning"></i>Type d'ordonnance</label>
              <p>{{ getPrescriptionTypeLabel(selectedProduct.prescriptionType) }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.drugForm">
              <label><i class="fas fa-pills me-2 text-info"></i>Forme galénique</label>
              <p>{{ getDrugFormLabel(selectedProduct.drugForm) }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.dosage">
              <label><i class="fas fa-syringe me-2 text-primary"></i>Dosage</label>
              <p>{{ selectedProduct.dosage }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.packaging">
              <label><i class="fas fa-box me-2 text-secondary"></i>Conditionnement</label>
              <p>{{ selectedProduct.packaging }}</p>
            </div>
          </div>

          <div class="col-md-6">
            <div class="info-group" *ngIf="selectedProduct.therapeuticClass">
              <label><i class="fas fa-medkit me-2 text-success"></i>Classe thérapeutique</label>
              <p>{{ selectedProduct.therapeuticClass }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.pharmacologicalClass">
              <label><i class="fas fa-flask me-2 text-info"></i>Classe pharmacologique</label>
              <p>{{ selectedProduct.pharmacologicalClass }}</p>
            </div>

            <div class="info-group" *ngIf="selectedProduct.ageRestriction?.minAge || selectedProduct.ageRestriction?.maxAge">
              <label><i class="fas fa-user-clock me-2 text-warning"></i>Restrictions d'âge</label>
              <p>
                <span *ngIf="selectedProduct.ageRestriction.minAge">
                  À partir de {{ selectedProduct.ageRestriction.minAge }} ans
                </span>
                <span *ngIf="selectedProduct.ageRestriction.minAge && selectedProduct.ageRestriction.maxAge"> - </span>
                <span *ngIf="selectedProduct.ageRestriction.maxAge">
                  Jusqu'à {{ selectedProduct.ageRestriction.maxAge }} ans
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- Active Ingredients -->
        <div class="mt-3" *ngIf="selectedProduct.activeIngredients?.length">
          <h6 class="mb-2">
            <i class="fas fa-atom me-2 text-primary"></i>
            Principes actifs
          </h6>
          <div class="d-flex flex-wrap gap-2">
            <span *ngFor="let ingredient of selectedProduct.activeIngredients" class="badge bg-info">
              {{ ingredient.name }}
              <span *ngIf="ingredient.dosage"> - {{ ingredient.dosage }}</span>
            </span>
          </div>
        </div>

        <!-- Therapeutic Indications -->
        <div class="mt-3" *ngIf="selectedProduct.indicationsTherapeutiques?.length">
          <h6 class="mb-2">
            <i class="fas fa-stethoscope me-2 text-success"></i>
            Indications thérapeutiques
          </h6>
          <ul class="list-group">
            <li *ngFor="let indication of selectedProduct.indicationsTherapeutiques" class="list-group-item">
              <i class="fas fa-check-circle text-success me-2"></i>
              {{ indication }}
            </li>
          </ul>
        </div>

        <!-- Safety Information -->
        <div class="row mt-4">
          <div class="col-md-4" *ngIf="selectedProduct.contraindications?.length">
            <div class="card border-danger">
              <div class="card-header bg-danger text-white">
                <h6 class="mb-0">
                  <i class="fas fa-ban me-2"></i>
                  Contre-indications
                </h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled mb-0">
                  <li *ngFor="let contraindication of selectedProduct.contraindications" class="mb-2">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    <small>{{ contraindication }}</small>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="col-md-4" *ngIf="selectedProduct.sideEffects?.length">
            <div class="card border-warning">
              <div class="card-header bg-warning text-dark">
                <h6 class="mb-0">
                  <i class="fas fa-exclamation-triangle me-2"></i>
                  Effets secondaires
                </h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled mb-0">
                  <li *ngFor="let effect of selectedProduct.sideEffects" class="mb-2">
                    <i class="fas fa-circle text-warning me-2" style="font-size: 0.5rem;"></i>
                    <small>{{ effect }}</small>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <div class="col-md-4" *ngIf="selectedProduct.warnings?.length">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="fas fa-info-circle me-2"></i>
                  Avertissements
                </h6>
              </div>
              <div class="card-body">
                <ul class="list-unstyled mb-0">
                  <li *ngFor="let warning of selectedProduct.warnings" class="mb-2">
                    <i class="fas fa-info-circle text-info me-2"></i>
                    <small>{{ warning }}</small>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Info -->
        <div class="row mt-4">
          <div class="col-md-6" *ngIf="selectedProduct.instructions">
            <div class="alert alert-info">
              <h6 class="alert-heading">
                <i class="fas fa-book-medical me-2"></i>
                Instructions d'utilisation
              </h6>
              <p class="mb-0">{{ selectedProduct.instructions }}</p>
            </div>
          </div>

          <div class="col-md-6" *ngIf="selectedProduct.storage">
            <div class="alert alert-warning">
              <h6 class="alert-heading">
                <i class="fas fa-thermometer-half me-2"></i>
                Conditions de stockage
              </h6>
              <p class="mb-0">{{ selectedProduct.storage }}</p>
            </div>
          </div>
        </div>

        <!-- Delivery Info -->
        <div class="mt-3" *ngIf="selectedProduct.deliveryInfo">
          <h6 class="mb-2">
            <i class="fas fa-shipping-fast me-2 text-primary"></i>
            Informations de livraison
          </h6>
          <div class="d-flex gap-3">
            <span class="badge" [ngClass]="selectedProduct.deliveryInfo.isFragile ? 'bg-warning' : 'bg-secondary'">
              <i class="fas fa-wine-glass-alt me-1"></i>
              {{ selectedProduct.deliveryInfo.isFragile ? 'Fragile' : 'Non fragile' }}
            </span>
            <span class="badge" [ngClass]="selectedProduct.deliveryInfo.requiresColdChain ? 'bg-info' : 'bg-secondary'">
              <i class="fas fa-snowflake me-1"></i>
              {{ selectedProduct.deliveryInfo.requiresColdChain ? 'Chaîne du froid' : 'Température ambiante' }}
            </span>
            <span class="badge bg-secondary" *ngIf="selectedProduct.weight">
              <i class="fas fa-weight me-1"></i>
              {{ selectedProduct.weight }}g
            </span>
          </div>
        </div>
      </div>

      <!-- Images Tab -->
      <div *ngIf="productModalTab === 'images'" class="tab-pane fade show active">
        <div class="row g-3">
          <!-- Main Image -->
          <div class="col-md-4" *ngIf="selectedProduct.getMainImageUrl()">
            <div class="image-card main-image">
              <img [src]="internalPathUrl + selectedProduct.getMainImageUrl()"
                   alt="Image principale"
                   class="img-fluid rounded"
                   style="width: 100%; height: 250px; object-fit: cover;">
              <div class="image-overlay">
                <span class="badge bg-primary">Image principale</span>
              </div>
            </div>
          </div>

          <!-- Additional Images -->
          <div class="col-md-4" *ngFor="let image of selectedProduct.images">
            <div class="image-card">
              <img [src]="internalPathUrl + image.url"
                   alt="Image additionnelle"
                   class="img-fluid rounded"
                   style="width: 100%; height: 250px; object-fit: cover;">
            </div>
          </div>
        </div>

        <div *ngIf="!selectedProduct.getMainImageUrl() && !selectedProduct.images?.length"
             class="text-center py-5">
          <i class="fas fa-images fa-4x text-muted mb-3"></i>
          <h5>Aucune image disponible</h5>
          <p class="text-muted">Ce produit n'a pas d'images associées.</p>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">
      <i class="fas fa-times me-2"></i>
      Fermer
    </button>
    <button type="button" class="btn btn-outline-primary" (click)="printProductDetails()">
      <i class="fas fa-print me-2"></i>
      Imprimer
    </button>
    <button type="button" class="btn btn-primary" (click)="navigateToProductDetail()">
      <i class="fas fa-external-link-alt me-2"></i>
      Voir détails complets
    </button>
  </div>
</ng-template>
<!-- Prescription Upload/View Modal -->
<ng-template #prescriptionModal>
  <div class="modal-header">
    <h4 class="modal-title">
      {{ permissions.editOrder ? 'Télécharger l\'ordonnance' : 'Visualiser l\'ordonnance' }}
    </h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <!-- View prescription -->
    <div class="prescription-viewer">
      <div class="text-center mb-3" *ngIf="prescriptionModalData.document">
        <img [src]="prescriptionModalData.document"
             class="img-fluid"
             style="max-height: 500px; border: 1px solid #ddd; border-radius: 8px;">
      </div>

      <div *ngIf="prescriptionModalData" class="prescription-info">
        <h6>Détails de l'ordonnance</h6>
        <div class="row">
          <div class="col-sm-6">
            <strong>Numéro:</strong> {{ prescriptionModalData.prescriptionNumber }}
          </div>
          <div class="col-sm-6">
            <strong>Date:</strong> {{ formatDate(prescriptionModalData.issueDate) }}
          </div>
        </div>
        <div class="mt-2" *ngIf="prescriptionModalData.doctor">
          <strong>Médecin:</strong> {{ prescriptionModalData.doctor.name }}
        </div>
<!--        <div class="mt-2" *ngIf="prescriptionModalData.">-->
<!--          <strong>Notes:</strong> {{ prescriptionModalData.notes }}-->
<!--        </div>-->
      </div>

      <div *ngIf="!prescriptionModalData.document" class="text-center text-muted py-4">
        <i class="fas fa-file-medical fa-3x mb-3"></i>
        <p>Aucune ordonnance disponible</p>
      </div>
    </div>

    <!-- Upload prescription -->
<!--    <div *ngIf="permissions.editOrder" class="prescription-uploader">-->
<!--      <div class="mb-3">-->
<!--        <label for="prescriptionFile" class="form-label">Sélectionner le fichier de l'ordonnance</label>-->
<!--        <input type="file"-->
<!--               id="prescriptionFile"-->
<!--               class="form-control"-->
<!--               accept="image/*,.pdf"-->
<!--               (change)="onPrescriptionFileSelected($event)">-->
<!--        <div class="form-text">Formats acceptés: JPG, PNG, PDF (taille max: 5MB)</div>-->
<!--      </div>-->

<!--      <div *ngIf="selectedPrescriptionFile" class="alert alert-info">-->
<!--        <i class="fas fa-file me-2"></i>-->
<!--        <strong>Fichier sélectionné:</strong> {{ selectedPrescriptionFile.name }}-->
<!--        <br>-->
<!--        <small>Taille: {{ (selectedPrescriptionFile.size / 1024 / 1024).toFixed(2) }} MB</small>-->
<!--      </div>-->

<!--      <div class="mb-3">-->
<!--        <label for="prescriptionNotes" class="form-label">Notes (optionnel)</label>-->
<!--        <textarea id="prescriptionNotes"-->
<!--                  class="form-control"-->
<!--                  rows="3"-->
<!--                  [(ngModel)]="prescriptionNotes"-->
<!--                  placeholder="Ajouter des notes sur cette ordonnance..."></textarea>-->
<!--      </div>-->

<!--      <div *ngIf="prescriptionModalData.orderItem" class="alert alert-light">-->
<!--        <strong>Produit concerné:</strong> {{ prescriptionModalData.orderItem.product.name }}-->
<!--        <br>-->
<!--        <small>Quantité: {{ prescriptionModalData.orderItem.quantity }}</small>-->
<!--      </div>-->
<!--    </div>-->
  </div>
<!--  <div class="modal-footer">-->
<!--    <button type="button" class="btn btn-secondary" (click)="closeModal()">-->
<!--      {{ prescriptionModalData?.type === 'upload' ? 'Annuler' : 'Fermer' }}-->
<!--    </button>-->
<!--    <button *ngIf="prescriptionModalData?.type === 'upload'"-->
<!--            type="button"-->
<!--            class="btn btn-primary"-->
<!--            [disabled]="!selectedPrescriptionFile || isSubmitting"-->
<!--            (click)="uploadPrescriptionFile()">-->
<!--      <span *ngIf="isSubmitting" class="spinner-border spinner-border-sm me-2"></span>-->
<!--      <i class="fas fa-upload me-2" *ngIf="!isSubmitting"></i>-->
<!--      Télécharger l'ordonnance-->
<!--    </button>-->
<!--    <button *ngIf="prescriptionModalData?.type === 'view' && prescriptionModalData.document"-->
<!--            type="button"-->
<!--            class="btn btn-outline-primary"-->
<!--            (click)="downloadPrescription()">-->
<!--      <i class="fas fa-download me-2"></i>-->
<!--      Télécharger-->
<!--    </button>-->
<!--  </div>-->
</ng-template>

<!-- Print Options Modal -->
<ng-template #printModal>
  <div class="modal-header">
    <h4 class="modal-title">Options d'impression</h4>
    <button type="button" class="btn-close" (click)="closeModal()"></button>
  </div>
  <div class="modal-body">
    <div class="mb-4">
      <h6>Format d'impression</h6>
      <div class="btn-group" role="group">
        <input type="radio" class="btn-check" name="printFormat" id="format-invoice"
               [(ngModel)]="printOptions.format" value="invoice">
        <label class="btn btn-outline-primary" for="format-invoice">
          <i class="fas fa-file-invoice me-2"></i>Facture
        </label>

        <input type="radio" class="btn-check" name="printFormat" id="format-receipt"
               [(ngModel)]="printOptions.format" value="receipt">
        <label class="btn btn-outline-primary" for="format-receipt">
          <i class="fas fa-receipt me-2"></i>Reçu
        </label>

        <input type="radio" class="btn-check" name="printFormat" id="format-label"
               [(ngModel)]="printOptions.format" value="label">
        <label class="btn btn-outline-primary" for="format-label">
          <i class="fas fa-tag me-2"></i>Étiquette
        </label>
      </div>
    </div>

    <div class="mb-3">
      <h6>Éléments à inclure</h6>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include-customer"
               [(ngModel)]="printOptions.includeCustomerInfo">
        <label class="form-check-label" for="include-customer">
          Informations client
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include-items"
               [(ngModel)]="printOptions.includeItems">
        <label class="form-check-label" for="include-items">
          Liste des articles
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include-payment"
               [(ngModel)]="printOptions.includePayment">
        <label class="form-check-label" for="include-payment">
          Informations de paiement
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include-delivery"
               [(ngModel)]="printOptions.includeDelivery">
        <label class="form-check-label" for="include-delivery">
          Adresse de livraison
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="include-notes"
               [(ngModel)]="printOptions.includeNotes">
        <label class="form-check-label" for="include-notes">
          Notes et commentaires
        </label>
      </div>
    </div>

    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      L'impression s'ouvrira dans une nouvelle fenêtre
    </div>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="closeModal()">Annuler</button>
    <button type="button" class="btn btn-primary" (click)="printOrder(printOptions.format)">
      <i class="fas fa-print me-2"></i>Imprimer
    </button>
  </div>
</ng-template>

